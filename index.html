<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Summary Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        .upload-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .upload-zone.has-file {
            border-color: #22c55e;
            background-color: #f0fdf4;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
        }
        @media print {
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
        }
        .status-select {
            min-width: 90px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
        }
        .status-present { background-color: #dcfce7; color: #166534; }
        .status-absent { background-color: #fee2e2; color: #991b1b; }
        .status-sick { background-color: #fef3c7; color: #92400e; }
        .status-excused { background-color: #e0e7ff; color: #3730a3; }
        .status-normal { background-color: #f3f4f6; color: #374151; }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .compact-table td, .compact-table th {
            padding: 4px 8px !important;
            font-size: 11px !important;
        }
        .compact-table .status-badge {
            padding: 1px 6px !important;
            font-size: 10px !important;
        }
        .login-modal {
            backdrop-filter: blur(4px);
        }
        .admin-only {
            display: none !important;
        }
        .admin-mode .admin-only {
            display: block !important;
        }
        .admin-mode .admin-only.hidden {
            display: none !important;
        }
        .admin-mode .admin-only-inline {
            display: inline-flex !important;
        }
        .admin-mode .public-only {
            display: none !important;
        }
        .public-only {
            display: block;
        }
        .sync-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .firebase-connected { background-color: #dcfce7; color: #166534; }
        .firebase-disconnected { background-color: #fee2e2; color: #991b1b; }
        .firebase-syncing { background-color: #fef3c7; color: #92400e; }
        .date-chip {
            cursor: pointer;
            transition: all 0.2s;
        }
        .date-chip:hover {
            transform: scale(1.05);
        }
        .date-chip.selected {
            ring: 2px;
            ring-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" class="firebase-status firebase-disconnected no-print">
        üî¥ Connecting...
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 login-modal hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                <h2 class="text-2xl font-bold text-red-600" id="deleteModalTitle">Confirm Delete</h2>
                <p class="text-gray-600 mt-2" id="deleteModalMessage">Are you sure you want to delete this dashboard?</p>
            </div>
            
            <div class="bg-red-50 rounded-xl p-4 mb-4">
                <div class="text-sm text-red-700 mb-3">
                    <strong>üîê Admin Re-Authentication Required</strong><br>
                    Please enter your admin credentials to confirm deletion.
                </div>
                <input type="email" id="deleteConfirmEmail" placeholder="Admin Email" 
                    class="w-full px-4 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 mb-2">
                <input type="password" id="deleteConfirmPassword" placeholder="Admin Password" 
                    class="w-full px-4 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                    onkeypress="if(event.key === 'Enter') confirmDelete()">
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 py-3 px-6 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition-all">
                    Cancel
                </button>
                <button onclick="confirmDelete()" class="flex-1 py-3 px-6 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow-lg transition-all">
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Access Control Modal -->
    <div id="accessModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 login-modal">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">üîê</div>
                <h2 class="text-2xl font-bold text-gray-800">Access Portal</h2>
                <p class="text-gray-600 mt-2">Choose your access level</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="enterPublicMode()" class="w-full py-4 px-6 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-xl shadow-lg transition-all flex items-center justify-center gap-3">
                    <span class="text-2xl">üëÅÔ∏è</span>
                    <div class="text-left">
                        <div class="font-bold">Public View</div>
                        <div class="text-sm opacity-90">View Dashboard Only</div>
                    </div>
                </button>
                
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">or</span>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-xl p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-2xl">üîë</span>
                        <div>
                            <div class="font-bold text-gray-800">Admin Access</div>
                            <div class="text-sm text-gray-600">Full Control</div>
                        </div>
                    </div>
                    <input type="email" id="adminEmail" placeholder="Admin Email" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 mb-2">
                    <input type="password" id="adminPassword" placeholder="Admin Password" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 mb-3"
                        onkeypress="if(event.key === 'Enter') enterAdminMode()">
                    <button onclick="enterAdminMode()" id="adminLoginBtn" class="w-full py-3 px-6 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-semibold rounded-lg shadow-lg transition-all">
                        Login as Admin
                    </button>
                    <div id="adminLoginError" class="text-red-500 text-sm mt-2 hidden"></div>
                </div>
            </div>
            
            <p class="text-center text-xs text-gray-400 mt-6">Firebase Email/Password authentication required for admin access</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl" id="mainContent" style="display: none;">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex justify-center items-center gap-4 mb-2">
                <h1 class="text-3xl font-bold text-gray-800">üìä Report Summary Generator</h1>
                <span id="accessBadge" class="px-3 py-1 rounded-full text-sm font-medium"></span>
            </div>
            <p class="text-gray-600">Upload Excel files, filter by date, and generate summary reports by enumerator groups</p>
            <div class="flex justify-center gap-4 mt-2">
                <button onclick="switchAccessMode()" class="text-sm text-purple-600 hover:text-purple-800 underline no-print">
                    Switch Access Mode
                </button>
                <span id="logoutBtn" class="admin-only">
                    <button onclick="logoutAdmin()" class="text-sm text-red-600 hover:text-red-800 underline no-print">
                        üö™ Logout
                    </button>
                </span>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-t-xl shadow-md mb-0 no-print" id="tabNavigation">
            <div class="flex border-b">
                <button onclick="switchTab('data')" id="tab-data" class="flex-1 py-4 px-6 font-semibold text-gray-600 hover:text-blue-600 transition-colors tab-active admin-only">
                    üìÅ Data Upload
                </button>
                <button onclick="switchTab('mapping')" id="tab-mapping" class="flex-1 py-4 px-6 font-semibold text-gray-600 hover:text-blue-600 transition-colors admin-only">
                    üë• Enumerator Mapping
                </button>
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="flex-1 py-4 px-6 font-semibold text-gray-600 hover:text-blue-600 transition-colors">
                    üìä Dashboard
                </button>
            </div>
        </div>

        <!-- Data Upload Tab -->
        <div id="content-data" class="tab-content admin-only">
            <div class="grid lg:grid-cols-3 gap-6">
                <!-- Left Column: File Uploads -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Date Selection -->
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <span>üìÖ</span> Date Selection
                        </h2>
                        <div class="flex flex-wrap gap-4 items-end">
                            <div class="flex items-center gap-4 mb-4">
                                <label class="flex items-center gap-2">
                                    <input type="radio" name="dateMode" value="single" checked class="text-blue-600" onchange="toggleDateMode()">
                                    <span>Single Date</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="radio" name="dateMode" value="range" class="text-blue-600" onchange="toggleDateMode()">
                                    <span>Date Range</span>
                                </label>
                            </div>
                            <div class="flex flex-wrap gap-4 w-full">
                                <div class="flex-1 min-w-[200px]">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                    <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div class="flex-1 min-w-[200px]" id="endDateContainer">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                    <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File Uploads Grid -->
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <span>üìÅ</span> Upload Data Files
                        </h2>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="upload-zone rounded-lg p-4 text-center cursor-pointer" id="zone-dss" onclick="document.getElementById('file-dss').click()">
                                <input type="file" id="file-dss" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileUpload(this, 'dss')">
                                <div class="text-3xl mb-2">üè≠</div>
                                <div class="font-medium text-gray-700">DT / Substation</div>
                                <div class="text-sm text-gray-500" id="status-dss">Click or drag to upload</div>
                            </div>

                            <div class="upload-zone rounded-lg p-4 text-center cursor-pointer" id="zone-ht" onclick="document.getElementById('file-ht').click()">
                                <input type="file" id="file-ht" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileUpload(this, 'ht')">
                                <div class="text-3xl mb-2">üîå</div>
                                <div class="font-medium text-gray-700">HT Pole</div>
                                <div class="text-sm text-gray-500" id="status-ht">Click or drag to upload</div>
                            </div>

                            <div class="upload-zone rounded-lg p-4 text-center cursor-pointer" id="zone-lt" onclick="document.getElementById('file-lt').click()">
                                <input type="file" id="file-lt" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileUpload(this, 'lt')">
                                <div class="text-3xl mb-2">üí°</div>
                                <div class="font-medium text-gray-700">LT Pole</div>
                                <div class="text-sm text-gray-500" id="status-lt">Click or drag to upload</div>
                            </div>

                            <div class="upload-zone rounded-lg p-4 text-center cursor-pointer" id="zone-cust" onclick="document.getElementById('file-cust').click()">
                                <input type="file" id="file-cust" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileUpload(this, 'cust')">
                                <div class="text-3xl mb-2">üë•</div>
                                <div class="font-medium text-gray-700">Customer Enumeration</div>
                                <div class="text-sm text-gray-500" id="status-cust">Click or drag to upload</div>
                            </div>

                            <div class="upload-zone rounded-lg p-4 text-center cursor-pointer md:col-span-2" id="zone-issues" onclick="document.getElementById('file-issues').click()">
                                <input type="file" id="file-issues" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileUpload(this, 'issues')">
                                <div class="text-3xl mb-2">‚ö†Ô∏è</div>
                                <div class="font-medium text-gray-700">Issue Log</div>
                                <div class="text-sm text-gray-500" id="status-issues">Click or drag to upload</div>
                            </div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="flex gap-4 flex-wrap">
                        <button onclick="generateReport()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                            <span>üìä</span> Generate Report
                        </button>
                        <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                            <span>üì•</span> Export Excel
                        </button>
                        <button onclick="clearAll()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors">
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Right Column: Quick Stats -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <span>üìà</span> Upload Status
                    </h2>
                    <div class="space-y-4">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-600">Files Uploaded</div>
                            <div class="text-2xl font-bold text-gray-800" id="filesCount">0 / 5</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-600">Total Records</div>
                            <div class="text-2xl font-bold text-gray-800" id="totalRecords">0</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-600">Enumerators Mapped</div>
                            <div class="text-2xl font-bold text-gray-800" id="mappedCount">0</div>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-lg">
                            <div class="text-sm text-purple-600">Saved Dashboards</div>
                            <div class="text-lg font-bold text-purple-800" id="savedDashboardsCount">0</div>
                        </div>
                    </div>
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-2">Status Legend</h3>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li><span class="inline-block w-3 h-3 rounded bg-green-400 mr-2"></span>Present - Working</li>
                            <li><span class="inline-block w-3 h-3 rounded bg-red-400 mr-2"></span>Absent - No show</li>
                            <li><span class="inline-block w-3 h-3 rounded bg-yellow-400 mr-2"></span>Sick - Health issues</li>
                            <li><span class="inline-block w-3 h-3 rounded bg-indigo-400 mr-2"></span>Excused - Permitted leave</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="mt-8 space-y-6" id="resultsSection" style="display: none;">
                <!-- AEDC Results -->
                <div class="bg-white rounded-xl shadow-md p-6 fade-in">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm">A</span>
                        AEDC Enumerators Report
                        <span id="dateRangeAedc" class="text-sm font-normal text-gray-500 ml-2"></span>
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm compact-table" id="resultsTableAedc">
                            <thead>
                                <tr class="bg-blue-50">
                                    <th class="px-3 py-2 text-left font-semibold text-gray-700 border-b">S/N</th>
                                    <th class="px-3 py-2 text-left font-semibold text-gray-700 border-b">Full Name</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">DT/DSS</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">HT Pole</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">Customer</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">LT Pole</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">Issues</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b bg-blue-100">Total/Status</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBodyAedc"></tbody>
                            <tfoot id="resultsTfootAedc" class="bg-blue-100 font-semibold"></tfoot>
                        </table>
                    </div>
                </div>

                <!-- BSS Results -->
                <div class="bg-white rounded-xl shadow-md p-6 fade-in">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm">B</span>
                        BSS Enumerators Report
                        <span id="dateRangeBss" class="text-sm font-normal text-gray-500 ml-2"></span>
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm compact-table" id="resultsTableBss">
                            <thead>
                                <tr class="bg-green-50">
                                    <th class="px-3 py-2 text-left font-semibold text-gray-700 border-b">S/N</th>
                                    <th class="px-3 py-2 text-left font-semibold text-gray-700 border-b">Full Name</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">DT/DSS</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">HT Pole</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">Customer</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">LT Pole</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">Issues</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b bg-green-100">Total/Status</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBodyBss"></tbody>
                            <tfoot id="resultsTfootBss" class="bg-green-100 font-semibold"></tfoot>
                        </table>
                    </div>
                </div>

                <!-- NYSC Results -->
                <div class="bg-white rounded-xl shadow-md p-6 fade-in">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="w-8 h-8 bg-orange-500 text-white rounded-full flex items-center justify-center text-sm">N</span>
                        NYSC Enumerators Report
                        <span id="dateRangeNysc" class="text-sm font-normal text-gray-500 ml-2"></span>
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm compact-table" id="resultsTableNysc">
                            <thead>
                                <tr class="bg-orange-50">
                                    <th class="px-3 py-2 text-left font-semibold text-gray-700 border-b">S/N</th>
                                    <th class="px-3 py-2 text-left font-semibold text-gray-700 border-b">Full Name</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">DT/DSS</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">HT Pole</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">Customer</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">LT Pole</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b">Issues</th>
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 border-b bg-orange-100">Total/Status</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBodyNysc"></tbody>
                            <tfoot id="resultsTfootNysc" class="bg-orange-100 font-semibold"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mapping Tab -->
        <div id="content-mapping" class="tab-content hidden admin-only">
            <div class="space-y-6">
                <!-- AEDC Enumerators -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm">A</span>
                        AEDC Enumerators
                    </h2>
                    <div class="space-y-3 mb-4" id="mappingContainer-aedc"></div>
                    <button onclick="addMappingRow('aedc')" class="w-full py-2 px-4 border-2 border-dashed border-blue-300 rounded-lg text-blue-600 hover:border-blue-500 hover:bg-blue-50 transition-colors">
                        + Add AEDC Enumerator
                    </button>
                    <div class="mt-4 pt-4 border-t">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quick Import (CSV: username,fullname)</label>
                        <textarea id="bulkMapping-aedc" rows="2" placeholder="username1,Full Name 1&#10;username2,Full Name 2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
                        <button onclick="importMappings('aedc')" class="mt-2 w-full py-2 px-4 bg-blue-100 hover:bg-blue-200 rounded-lg text-sm font-medium transition-colors text-blue-700">
                            Import AEDC Mappings
                        </button>
                    </div>
                </div>

                <!-- BSS Enumerators -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm">B</span>
                        BSS Enumerators
                    </h2>
                    <div class="space-y-3 mb-4" id="mappingContainer-bss"></div>
                    <button onclick="addMappingRow('bss')" class="w-full py-2 px-4 border-2 border-dashed border-green-300 rounded-lg text-green-600 hover:border-green-500 hover:bg-green-50 transition-colors">
                        + Add BSS Enumerator
                    </button>
                    <div class="mt-4 pt-4 border-t">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quick Import (CSV: username,fullname)</label>
                        <textarea id="bulkMapping-bss" rows="2" placeholder="username1,Full Name 1&#10;username2,Full Name 2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
                        <button onclick="importMappings('bss')" class="mt-2 w-full py-2 px-4 bg-green-100 hover:bg-green-200 rounded-lg text-sm font-medium transition-colors text-green-700">
                            Import BSS Mappings
                        </button>
                    </div>
                </div>

                <!-- NYSC Enumerators -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="w-8 h-8 bg-orange-500 text-white rounded-full flex items-center justify-center text-sm">N</span>
                        NYSC Enumerators
                    </h2>
                    <div class="space-y-3 mb-4" id="mappingContainer-nysc"></div>
                    <button onclick="addMappingRow('nysc')" class="w-full py-2 px-4 border-2 border-dashed border-orange-300 rounded-lg text-orange-600 hover:border-orange-500 hover:bg-orange-50 transition-colors">
                        + Add NYSC Enumerator
                    </button>
                    <div class="mt-4 pt-4 border-t">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quick Import (CSV: username,fullname)</label>
                        <textarea id="bulkMapping-nysc" rows="2" placeholder="username1,Full Name 1&#10;username2,Full Name 2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
                        <button onclick="importMappings('nysc')" class="mt-2 w-full py-2 px-4 bg-orange-100 hover:bg-orange-200 rounded-lg text-sm font-medium transition-colors text-orange-700">
                            Import NYSC Mappings
                        </button>
                    </div>
                </div>

                <!-- Save Mappings Button -->
                <div class="flex gap-4">
                    <button onclick="saveMappingsToCloud()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                        <span>‚òÅÔ∏è</span> Save Mappings to Cloud
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="content-dashboard" class="tab-content hidden">
            <!-- Date Selection for Dashboard (Public View) -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-6 no-print">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <span>üìÖ</span> Select Dashboard Date
                </h2>
                
                <!-- Date Mode Selection -->
                <div class="flex items-center gap-4 mb-4">
                    <label class="flex items-center gap-2">
                        <input type="radio" name="dashDateMode" value="single" checked class="text-blue-600" onchange="toggleDashDateMode()">
                        <span>Single Date</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="radio" name="dashDateMode" value="range" class="text-blue-600" onchange="toggleDashDateMode()">
                        <span>Date Range</span>
                    </label>
                </div>
                
                <!-- Date Inputs -->
                <div class="flex flex-wrap gap-4 mb-4">
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="dashStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="loadDashboardForDate()">
                    </div>
                    <div class="flex-1 min-w-[200px]" id="dashEndDateContainer">
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="date" id="dashEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled onchange="loadDashboardForDate()">
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadDashboardForDate()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors">
                            Load Dashboard
                        </button>
                    </div>
                </div>
                
                <!-- Available Saved Dates -->
                <div class="mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700">üìÇ Available Saved Dashboards:</label>
                        <button onclick="showClearAllModal()" class="admin-only text-xs bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded-full transition-colors flex items-center gap-1">
                            üóëÔ∏è Clear All Dashboards
                        </button>
                    </div>
                    <div id="savedDatesList" class="flex flex-wrap gap-2">
                        <span class="text-gray-500 italic text-sm">No saved dashboards yet</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap justify-end gap-2 mb-4 no-print">
                <button onclick="saveDashboardToCloud()" class="admin-only bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition-colors flex items-center gap-1 text-sm">
                    <span>‚òÅÔ∏è</span> Save to Cloud
                </button>
                <button onclick="loadSavedDates()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition-colors flex items-center gap-1 text-sm">
                    <span>üîÑ</span> Refresh
                </button>
                <button onclick="exportToPNG('full')" class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition-colors flex items-center gap-1 text-sm">
                    <span>üì∏</span> Export PNG
                </button>
                <button onclick="printDashboard()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition-colors flex items-center gap-1 text-sm">
                    <span>üñ®Ô∏è</span> Print
                </button>
                <button onclick="exportDashboard()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition-colors flex items-center gap-1 text-sm">
                    <span>üì•</span> Export Excel
                </button>
            </div>
            
            <!-- Visibility Controls -->
            <div class="bg-white rounded-xl shadow-md p-4 mb-6 no-print">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <span>üëÅÔ∏è</span> Dashboard Visibility Controls
                </h3>
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showAedc" checked class="w-4 h-4 text-blue-600 rounded" onchange="toggleSection('aedc')">
                        <span class="text-sm text-gray-700">AEDC Table</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showBss" checked class="w-4 h-4 text-green-600 rounded" onchange="toggleSection('bss')">
                        <span class="text-sm text-gray-700">BSS Table</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showNysc" checked class="w-4 h-4 text-orange-600 rounded" onchange="toggleSection('nysc')">
                        <span class="text-sm text-gray-700">NYSC Table</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showGrandTotal" checked class="w-4 h-4 text-purple-600 rounded" onchange="toggleSection('grandTotal')">
                        <span class="text-sm text-gray-700">Grand Total</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showAbsentSick" checked class="w-4 h-4 text-red-600 rounded" onchange="toggleSection('absentSick')">
                        <span class="text-sm text-gray-700">Absent/Sick/Excused</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showCharts" checked class="w-4 h-4 text-indigo-600 rounded" onchange="toggleSection('charts')">
                        <span class="text-sm text-gray-700">Charts</span>
                    </label>
                </div>
                <div class="mt-3 pt-3 border-t flex gap-2">
                    <button onclick="showAllSections()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-full">Show All</button>
                    <button onclick="showOnlyAedc()" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-full">AEDC Only</button>
                    <button onclick="showOnlyBss()" class="text-xs bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded-full">BSS Only</button>
                    <button onclick="showOnlyNysc()" class="text-xs bg-orange-100 hover:bg-orange-200 text-orange-700 px-3 py-1 rounded-full">NYSC Only</button>
                </div>
            </div>
            
            <!-- Dashboard Content for PNG Export - Starts from Header -->
            <div id="dashboardCapture" style="background-color: #f3f4f6; padding: 20px; border-radius: 12px;">
            
            <!-- Dashboard Header with Date -->
            <div style="background: linear-gradient(to right, #9333ea, #2563eb); border-radius: 12px; padding: 32px; margin-bottom: 24px; color: white; text-align: center;">
                <h2 style="font-size: 1.875rem; font-weight: bold; margin-bottom: 8px;" id="dashboardDateHeader">üìä Enumeration Dashboard</h2>
                <p style="font-size: 1.125rem; opacity: 0.9;" id="dashboardSubtitle">Select a date to view dashboard</p>
            </div>

            <!-- Top/Least Performers Cards - Ultra Compact -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                <!-- AEDC Card -->
                <div style="background-color: #ffffff; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 8px; border-left: 3px solid #3b82f6;">
                    <div style="text-align: center; margin-bottom: 4px;">
                        <span style="font-size: 1rem;">üèÜ</span>
                        <h3 style="font-size: 0.8rem; font-weight: bold; color: #2563eb; margin: 0;">AEDC</h3>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <div style="background-color: #f0fdf4; padding: 3px 6px; border-radius: 4px;">
                            <div style="font-size: 0.55rem; color: #16a34a; font-weight: 600;">üèÖ Top Performer</div>
                            <div style="font-weight: bold; color: #166534; font-size: 0.7rem; line-height: 1.1;" id="aedcTopName">-</div>
                            <div style="font-size: 0.65rem; color: #16a34a;" id="aedcTopCount">(0)</div>
                        </div>
                        <div style="background-color: #fef2f2; padding: 3px 6px; border-radius: 4px;">
                            <div style="font-size: 0.55rem; color: #dc2626; font-weight: 600;">üìâ Least Performer</div>
                            <div style="font-weight: bold; color: #991b1b; font-size: 0.7rem; line-height: 1.1;" id="aedcLeastName">-</div>
                            <div style="font-size: 0.65rem; color: #dc2626;" id="aedcLeastCount">(0)</div>
                        </div>
                        <div style="background-color: #dbeafe; padding: 3px 6px; border-radius: 4px; text-align: center;">
                            <div style="font-size: 1rem; font-weight: bold; color: #1e40af; line-height: 1;" id="aedcTotalDash">0</div>
                            <div style="font-size: 0.5rem; color: #2563eb;">Total Entries</div>
                        </div>
                    </div>
                </div>

                <!-- BSS Card -->
                <div style="background-color: #ffffff; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 8px; border-left: 3px solid #22c55e;">
                    <div style="text-align: center; margin-bottom: 4px;">
                        <span style="font-size: 1rem;">üèÜ</span>
                        <h3 style="font-size: 0.8rem; font-weight: bold; color: #16a34a; margin: 0;">BSS</h3>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <div style="background-color: #f0fdf4; padding: 3px 6px; border-radius: 4px;">
                            <div style="font-size: 0.55rem; color: #16a34a; font-weight: 600;">üèÖ Top Performer</div>
                            <div style="font-weight: bold; color: #166534; font-size: 0.7rem; line-height: 1.1;" id="bssTopName">-</div>
                            <div style="font-size: 0.65rem; color: #16a34a;" id="bssTopCount">(0)</div>
                        </div>
                        <div style="background-color: #fef2f2; padding: 3px 6px; border-radius: 4px;">
                            <div style="font-size: 0.55rem; color: #dc2626; font-weight: 600;">üìâ Least Performer</div>
                            <div style="font-weight: bold; color: #991b1b; font-size: 0.7rem; line-height: 1.1;" id="bssLeastName">-</div>
                            <div style="font-size: 0.65rem; color: #dc2626;" id="bssLeastCount">(0)</div>
                        </div>
                        <div style="background-color: #dcfce7; padding: 3px 6px; border-radius: 4px; text-align: center;">
                            <div style="font-size: 1rem; font-weight: bold; color: #166534; line-height: 1;" id="bssTotalDash">0</div>
                            <div style="font-size: 0.5rem; color: #16a34a;">Total Entries</div>
                        </div>
                    </div>
                </div>

                <!-- NYSC Card -->
                <div style="background-color: #ffffff; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 8px; border-left: 3px solid #f97316;">
                    <div style="text-align: center; margin-bottom: 4px;">
                        <span style="font-size: 1rem;">üèÜ</span>
                        <h3 style="font-size: 0.8rem; font-weight: bold; color: #ea580c; margin: 0;">NYSC</h3>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <div style="background-color: #f0fdf4; padding: 3px 6px; border-radius: 4px;">
                            <div style="font-size: 0.55rem; color: #16a34a; font-weight: 600;">üèÖ Top Performer</div>
                            <div style="font-weight: bold; color: #166534; font-size: 0.7rem; line-height: 1.1;" id="nyscTopName">-</div>
                            <div style="font-size: 0.65rem; color: #16a34a;" id="nyscTopCount">(0)</div>
                        </div>
                        <div style="background-color: #fef2f2; padding: 3px 6px; border-radius: 4px;">
                            <div style="font-size: 0.55rem; color: #dc2626; font-weight: 600;">üìâ Least Performer</div>
                            <div style="font-weight: bold; color: #991b1b; font-size: 0.7rem; line-height: 1.1;" id="nyscLeastName">-</div>
                            <div style="font-size: 0.65rem; color: #dc2626;" id="nyscLeastCount">(0)</div>
                        </div>
                        <div style="background-color: #ffedd5; padding: 3px 6px; border-radius: 4px; text-align: center;">
                            <div style="font-size: 1rem; font-weight: bold; color: #9a3412; line-height: 1;" id="nyscTotalDash">0</div>
                            <div style="font-size: 0.5rem; color: #ea580c;">Total Entries</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Summary Cards - Ultra Compact -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px;">
                <div style="background: linear-gradient(to bottom right, #4ade80, #16a34a); border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 4px 8px; color: white; text-align: center;">
                    <div style="font-size: 1rem; line-height: 1;">üë•</div>
                    <div style="font-size: 0.6rem; opacity: 0.9; line-height: 1;">Present</div>
                    <div style="font-size: 1.25rem; font-weight: bold; line-height: 1.2;" id="presentCount">0</div>
                </div>
                <div style="background: linear-gradient(to bottom right, #f87171, #dc2626); border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 4px 8px; color: white; text-align: center;">
                    <div style="font-size: 1rem; line-height: 1;">üö´</div>
                    <div style="font-size: 0.6rem; opacity: 0.9; line-height: 1;">Absent</div>
                    <div style="font-size: 1.25rem; font-weight: bold; line-height: 1.2;" id="absentCount">0</div>
                </div>
                <div style="background: linear-gradient(to bottom right, #818cf8, #4f46e5); border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 4px 8px; color: white; text-align: center;">
                    <div style="font-size: 1rem; line-height: 1;">üìù</div>
                    <div style="font-size: 0.6rem; opacity: 0.9; line-height: 1;">Excused</div>
                    <div style="font-size: 1.25rem; font-weight: bold; line-height: 1.2;" id="excusedCount">0</div>
                </div>
                <div style="background: linear-gradient(to bottom right, #facc15, #ca8a04); border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 4px 8px; color: white; text-align: center;">
                    <div style="font-size: 1rem; line-height: 1;">ü§í</div>
                    <div style="font-size: 0.6rem; opacity: 0.9; line-height: 1;">Sick</div>
                    <div style="font-size: 1.25rem; font-weight: bold; line-height: 1.2;" id="sickCount">0</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div id="sectionCharts" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 24px;">
                <!-- Pie Chart -->
                <div style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 24px;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 16px; text-align: center;">üìä Group Comparison</h3>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>

                <!-- Bar Chart -->
                <div style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 24px;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 16px; text-align: center;">üìà Asset Distribution</h3>
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- AEDC Dashboard Table -->
            <div id="sectionAedc" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 16px;">
                <h3 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <span style="width: 24px; height: 24px; background-color: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">A</span>
                    AEDC Enumerators
                </h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; font-size: 11px; border-collapse: collapse;" class="compact-table">
                        <thead>
                            <tr style="background-color: #eff6ff;">
                                <th style="text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">S/N</th>
                                <th style="text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Full Name</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">DT/DSS</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">HT Pole</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Customer</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">LT Pole</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Issues</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px; background-color: #dbeafe;">Total</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardBodyAedc"></tbody>
                        <tfoot id="dashboardTfootAedc" style="background-color: #dbeafe; font-weight: 600;"></tfoot>
                    </table>
                </div>
            </div>

            <!-- BSS Dashboard Table -->
            <div id="sectionBss" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 16px;">
                <h3 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <span style="width: 24px; height: 24px; background-color: #22c55e; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">B</span>
                    BSS Enumerators
                </h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; font-size: 11px; border-collapse: collapse;" class="compact-table">
                        <thead>
                            <tr style="background-color: #f0fdf4;">
                                <th style="text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">S/N</th>
                                <th style="text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Full Name</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">DT/DSS</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">HT Pole</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Customer</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">LT Pole</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Issues</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px; background-color: #dcfce7;">Total</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardBodyBss"></tbody>
                        <tfoot id="dashboardTfootBss" style="background-color: #dcfce7; font-weight: 600;"></tfoot>
                    </table>
                </div>
            </div>

            <!-- NYSC Dashboard Table -->
            <div id="sectionNysc" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 16px;">
                <h3 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <span style="width: 24px; height: 24px; background-color: #f97316; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">N</span>
                    NYSC Enumerators
                </h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; font-size: 11px; border-collapse: collapse;" class="compact-table">
                        <thead>
                            <tr style="background-color: #fff7ed;">
                                <th style="text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">S/N</th>
                                <th style="text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Full Name</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">DT/DSS</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">HT Pole</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Customer</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">LT Pole</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Issues</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px; background-color: #ffedd5;">Total</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardBodyNysc"></tbody>
                        <tfoot id="dashboardTfootNysc" style="background-color: #ffedd5; font-weight: 600;"></tfoot>
                    </table>
                </div>
            </div>

            <!-- Grand Total Summary -->
            <div id="sectionGrandTotal" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 16px;">
                <h3 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <span style="width: 24px; height: 24px; background-color: #a855f7; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">Œ£</span>
                    Grand Total Summary
                </h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; font-size: 11px; border-collapse: collapse;" class="compact-table" id="tableGrandTotal">
                        <thead>
                            <tr style="background-color: #faf5ff;">
                                <th style="text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Group</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">DT/DSS</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">HT Pole</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Customer</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">LT Pole</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px;">Issues</th>
                                <th style="text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding: 4px 8px; background-color: #e9d5ff;">Total</th>
                            </tr>
                        </thead>
                        <tbody id="bodyGrandTotal"></tbody>
                        <tfoot id="footGrandTotal" style="background-color: #e9d5ff; font-weight: bold;"></tfoot>
                    </table>
                </div>
            </div>

            <!-- Absent/Sick/Excused Lists -->
            <div id="sectionAbsentSick" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;">
                <div style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 24px; border-top: 4px solid #ef4444;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; color: #dc2626; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span>üö´</span> Absent Enumerators
                    </h3>
                    <ul style="display: flex; flex-direction: column; gap: 8px;" id="absentList">
                        <li style="color: #6b7280; font-style: italic;">None</li>
                    </ul>
                </div>
                <div style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 24px; border-top: 4px solid #eab308;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; color: #ca8a04; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span>ü§í</span> Sick Enumerators
                    </h3>
                    <ul style="display: flex; flex-direction: column; gap: 8px;" id="sickList">
                        <li style="color: #6b7280; font-style: italic;">None</li>
                    </ul>
                </div>
                <div style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 24px; border-top: 4px solid #6366f1;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; color: #4f46e5; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span>üìù</span> Excused Enumerators
                    </h3>
                    <ul style="display: flex; flex-direction: column; gap: 8px;" id="excusedList">
                        <li style="color: #6b7280; font-style: italic;">None</li>
                    </ul>
                </div>
            </div>
            </div><!-- End dashboardCapture -->
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg transition-all transform translate-y-20 opacity-0 no-print" style="z-index: 1000;"></div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        let database = null;
        let auth = null;
        let firebaseInitialized = false;
        let currentUser = null;

        // Access Control
        let isAdminMode = false;

        // Data storage
        const uploadedData = { dss: null, ht: null, lt: null, cust: null, issues: null };
        const usernameMappings = { aedc: new Map(), bss: new Map(), nysc: new Map() };
        
        // Report results storage
        let reportResults = {
            aedc: { results: [], totals: {} },
            bss: { results: [], totals: {} },
            nysc: { results: [], totals: {} },
            dateRange: '',
            formattedDate: '',
            dateKey: ''
        };

        // Saved dashboards storage
        let savedDashboards = {};
        let availableDates = [];

        // Chart instances
        let pieChart = null;
        let barChart = null;

        // ============================================
        // FIREBASE INITIALIZATION
        // ============================================
        function initFirebase() {
            try {
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.warn("Firebase not configured. Using local storage as fallback.");
                    updateFirebaseStatus('local', 'üíæ Local Storage');
                    loadFromLocalStorage();
                    return;
                }
                
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                auth = firebase.auth();
                firebaseInitialized = true;
                
                // Listen for auth state changes
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        console.log("User signed in:", user.email);
                    } else {
                        currentUser = null;
                        console.log("User signed out");
                    }
                });
                
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snap) => {
                    if (snap.val() === true) {
                        updateFirebaseStatus('connected', 'üü¢ Cloud Connected');
                        loadSavedDates();
                        loadMappingsFromCloud();
                    } else {
                        updateFirebaseStatus('disconnected', 'üî¥ Offline');
                    }
                });
                
            } catch (error) {
                console.error("Firebase initialization error:", error);
                updateFirebaseStatus('error', '‚ö†Ô∏è Cloud Error');
                loadFromLocalStorage();
            }
        }

        function updateFirebaseStatus(status, text) {
            const statusEl = document.getElementById('firebaseStatus');
            statusEl.textContent = text;
            statusEl.className = 'firebase-status no-print';
            
            switch(status) {
                case 'connected':
                    statusEl.classList.add('firebase-connected');
                    break;
                case 'disconnected':
                case 'error':
                    statusEl.classList.add('firebase-disconnected');
                    break;
                case 'syncing':
                    statusEl.classList.add('firebase-syncing', 'sync-indicator');
                    break;
                case 'local':
                    statusEl.classList.add('firebase-syncing');
                    break;
            }
        }

        // ============================================
        // CLOUD STORAGE FUNCTIONS
        // ============================================
        
        function saveDashboardToCloud() {
            if (!reportResults.dateKey) {
                showStatus('Generate a report first before saving', 'error');
                return;
            }
            
            updateFirebaseStatus('syncing', 'üîÑ Saving...');
            
            const dateKey = reportResults.dateKey;
            const dataToSave = {
                aedc: { results: reportResults.aedc.results, totals: reportResults.aedc.totals },
                bss: { results: reportResults.bss.results, totals: reportResults.bss.totals },
                nysc: { results: reportResults.nysc.results, totals: reportResults.nysc.totals },
                dateRange: reportResults.dateRange,
                formattedDate: reportResults.formattedDate,
                dateKey: dateKey,
                savedAt: new Date().toISOString()
            };
            
            if (firebaseInitialized && database) {
                database.ref('dashboards/' + dateKey).set(dataToSave)
                    .then(() => {
                        updateFirebaseStatus('connected', 'üü¢ Cloud Connected');
                        showStatus(`Dashboard saved for ${reportResults.formattedDate}!`, 'success');
                        loadSavedDates();
                    })
                    .catch((error) => {
                        console.error("Save error:", error);
                        saveToLocalStorage(dateKey, dataToSave);
                        updateFirebaseStatus('error', '‚ö†Ô∏è Save Error');
                        showStatus('Cloud save failed. Saved locally.', 'warning');
                    });
            } else {
                saveToLocalStorage(dateKey, dataToSave);
                showStatus('Dashboard saved locally', 'info');
                loadSavedDates();
            }
        }
        
        function loadSavedDates() {
            if (firebaseInitialized && database) {
                database.ref('dashboards').once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            savedDashboards = data;
                            availableDates = Object.keys(data).sort().reverse();
                            renderSavedDatesList();
                            document.getElementById('savedDashboardsCount').textContent = availableDates.length;
                            
                            // Load latest dashboard by default
                            if (availableDates.length > 0 && !reportResults.dateKey) {
                                loadDashboardByKey(availableDates[0]);
                            }
                        }
                        updateFirebaseStatus('connected', 'üü¢ Cloud Connected');
                    })
                    .catch((error) => {
                        console.error("Load dates error:", error);
                        loadDatesFromLocalStorage();
                    });
            } else {
                loadDatesFromLocalStorage();
            }
        }
        
        function loadDashboardByKey(dateKey) {
            const data = savedDashboards[dateKey];
            if (data) {
                reportResults.aedc = data.aedc || { results: [], totals: {} };
                reportResults.bss = data.bss || { results: [], totals: {} };
                reportResults.nysc = data.nysc || { results: [], totals: {} };
                reportResults.dateRange = data.dateRange || '';
                reportResults.formattedDate = data.formattedDate || '';
                reportResults.dateKey = data.dateKey || dateKey;
                
                updateDashboard();
                showStatus(`Loaded dashboard for ${data.formattedDate || dateKey}`, 'success');
            }
        }
        
        function loadDashboardForDate() {
            const startDate = document.getElementById('dashStartDate').value;
            const endDate = document.getElementById('dashEndDate').value;
            const isRange = document.querySelector('input[name="dashDateMode"]:checked').value === 'range';
            
            if (!startDate) {
                showStatus('Please select a date', 'error');
                return;
            }
            
            if (isRange && endDate) {
                // Load and aggregate multiple dates
                loadDashboardRange(startDate, endDate);
            } else {
                // Load single date
                const dateKey = startDate;
                if (savedDashboards[dateKey]) {
                    loadDashboardByKey(dateKey);
                } else {
                    showStatus(`No dashboard saved for ${formatDateHeader(startDate)}`, 'warning');
                }
            }
        }
        
        function loadDashboardRange(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Initialize aggregated results
            const aggregated = {
                aedc: { results: [], totals: { dss: 0, ht: 0, cust: 0, lt: 0, issues: 0, total: 0 } },
                bss: { results: [], totals: { dss: 0, ht: 0, cust: 0, lt: 0, issues: 0, total: 0 } },
                nysc: { results: [], totals: { dss: 0, ht: 0, cust: 0, lt: 0, issues: 0, total: 0 } }
            };
            
            // Maps to aggregate by fullname
            const maps = { aedc: new Map(), bss: new Map(), nysc: new Map() };
            
            let datesFound = 0;
            
            // Iterate through date range
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateKey = d.toISOString().split('T')[0];
                const data = savedDashboards[dateKey];
                
                if (data) {
                    datesFound++;
                    ['aedc', 'bss', 'nysc'].forEach(group => {
                        if (data[group] && data[group].results) {
                            data[group].results.forEach(r => {
                                const key = r.fullname;
                                if (maps[group].has(key)) {
                                    const existing = maps[group].get(key);
                                    existing.dss += r.dss || 0;
                                    existing.ht += r.ht || 0;
                                    existing.cust += r.cust || 0;
                                    existing.lt += r.lt || 0;
                                    existing.issues += r.issues || 0;
                                    existing.total += r.total || 0;
                                    // Keep latest status
                                    if (r.status !== 'present') existing.status = r.status;
                                } else {
                                    maps[group].set(key, {
                                        username: r.username,
                                        fullname: r.fullname,
                                        dss: r.dss || 0,
                                        ht: r.ht || 0,
                                        cust: r.cust || 0,
                                        lt: r.lt || 0,
                                        issues: r.issues || 0,
                                        total: r.total || 0,
                                        status: r.status || 'present'
                                    });
                                }
                            });
                        }
                    });
                }
            }
            
            if (datesFound === 0) {
                showStatus('No dashboards found in selected date range', 'warning');
                return;
            }
            
            // Convert maps to arrays and calculate totals
            ['aedc', 'bss', 'nysc'].forEach(group => {
                aggregated[group].results = Array.from(maps[group].values()).sort((a, b) => b.total - a.total);
                aggregated[group].results.forEach(r => {
                    aggregated[group].totals.dss += r.dss;
                    aggregated[group].totals.ht += r.ht;
                    aggregated[group].totals.cust += r.cust;
                    aggregated[group].totals.lt += r.lt;
                    aggregated[group].totals.issues += r.issues;
                    aggregated[group].totals.total += r.total;
                });
            });
            
            reportResults.aedc = aggregated.aedc;
            reportResults.bss = aggregated.bss;
            reportResults.nysc = aggregated.nysc;
            reportResults.formattedDate = `${formatDateHeader(startDate)} - ${formatDateHeader(endDate)}`;
            reportResults.dateRange = `(${startDate} to ${endDate})`;
            reportResults.dateKey = `${startDate}_to_${endDate}`;
            
            updateDashboard();
            showStatus(`Loaded ${datesFound} dashboards for date range`, 'success');
        }
        
        function renderSavedDatesList() {
            const container = document.getElementById('savedDatesList');
            
            if (availableDates.length === 0) {
                container.innerHTML = '<span class="text-gray-500 italic text-sm">No saved dashboards yet</span>';
                return;
            }
            
            container.innerHTML = availableDates.map(dateKey => {
                const formatted = formatDateHeader(dateKey);
                const deleteBtn = isAdminMode ? 
                    `<button onclick="event.stopPropagation(); showDeleteModal('${dateKey}')" class="ml-1 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-full w-5 h-5 inline-flex items-center justify-center text-xs" title="Delete this dashboard">‚úï</button>` : '';
                return `<div class="inline-flex items-center bg-purple-100 rounded-full">
                    <button onclick="loadDashboardByKey('${dateKey}')" class="date-chip px-3 py-1 hover:bg-purple-200 text-purple-700 rounded-full text-sm font-medium transition-colors">
                        üìÖ ${formatted}
                    </button>
                    ${deleteBtn}
                </div>`;
            }).join('');
        }
        
        function toggleDashDateMode() {
            const isRange = document.querySelector('input[name="dashDateMode"]:checked').value === 'range';
            document.getElementById('dashEndDate').disabled = !isRange;
        }
        
        function saveMappingsToCloud() {
            updateFirebaseStatus('syncing', 'üîÑ Saving Mappings...');
            
            const mappingsToSave = {
                aedc: Array.from(usernameMappings.aedc.entries()),
                bss: Array.from(usernameMappings.bss.entries()),
                nysc: Array.from(usernameMappings.nysc.entries()),
                lastUpdated: new Date().toISOString()
            };
            
            if (firebaseInitialized && database) {
                database.ref('mappings').set(mappingsToSave)
                    .then(() => {
                        updateFirebaseStatus('connected', 'üü¢ Cloud Connected');
                        showStatus('Mappings saved to cloud!', 'success');
                    })
                    .catch((error) => {
                        console.error("Mappings save error:", error);
                        localStorage.setItem('enumeratorMappings', JSON.stringify(mappingsToSave));
                        showStatus('Cloud save failed. Saved locally.', 'warning');
                    });
            } else {
                localStorage.setItem('enumeratorMappings', JSON.stringify(mappingsToSave));
                showStatus('Mappings saved locally', 'info');
            }
        }
        
        function loadMappingsFromCloud() {
            if (firebaseInitialized && database) {
                database.ref('mappings').once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            loadMappingsFromData(data);
                        }
                    })
                    .catch((error) => {
                        console.error("Mappings load error:", error);
                        loadMappingsFromLocalStorage();
                    });
            } else {
                loadMappingsFromLocalStorage();
            }
        }
        
        function saveToLocalStorage(dateKey, data) {
            try {
                const saved = JSON.parse(localStorage.getItem('savedDashboards') || '{}');
                saved[dateKey] = data;
                localStorage.setItem('savedDashboards', JSON.stringify(saved));
                savedDashboards = saved;
                availableDates = Object.keys(saved).sort().reverse();
                renderSavedDatesList();
            } catch (e) {
                console.error("Local storage error:", e);
            }
        }
        
        function loadDatesFromLocalStorage() {
            try {
                const saved = localStorage.getItem('savedDashboards');
                if (saved) {
                    savedDashboards = JSON.parse(saved);
                    availableDates = Object.keys(savedDashboards).sort().reverse();
                    renderSavedDatesList();
                    document.getElementById('savedDashboardsCount').textContent = availableDates.length;
                    
                    if (availableDates.length > 0 && !reportResults.dateKey) {
                        loadDashboardByKey(availableDates[0]);
                    }
                }
            } catch (e) {
                console.error("Local storage read error:", e);
            }
        }
        
        function loadFromLocalStorage() {
            loadDatesFromLocalStorage();
            loadMappingsFromLocalStorage();
        }
        
        function loadMappingsFromLocalStorage() {
            try {
                const saved = localStorage.getItem('enumeratorMappings');
                if (saved) {
                    loadMappingsFromData(JSON.parse(saved));
                }
            } catch (e) {
                console.error("Mappings local storage error:", e);
            }
        }
        
        function loadMappingsFromData(data) {
            if (data.aedc) {
                usernameMappings.aedc = new Map(data.aedc);
                renderMappingRows('aedc');
            }
            if (data.bss) {
                usernameMappings.bss = new Map(data.bss);
                renderMappingRows('bss');
            }
            if (data.nysc) {
                usernameMappings.nysc = new Map(data.nysc);
                renderMappingRows('nysc');
            }
            updateStats();
        }
        
        // ============================================
        // DELETE DASHBOARD FUNCTIONS
        // ============================================
        let pendingDeleteKey = null;
        let pendingDeleteType = 'single'; // 'single' or 'all'
        
        function showDeleteModal(dateKey) {
            pendingDeleteKey = dateKey;
            pendingDeleteType = 'single';
            const formatted = formatDateHeader(dateKey);
            document.getElementById('deleteModalTitle').textContent = 'Delete Dashboard';
            document.getElementById('deleteModalMessage').textContent = `Are you sure you want to delete the dashboard for "${formatted}"?`;
            // Pre-fill email if user is logged in
            document.getElementById('deleteConfirmEmail').value = currentUser ? currentUser.email : '';
            document.getElementById('deleteConfirmPassword').value = '';
            document.getElementById('deleteModal').classList.remove('hidden');
        }
        
        function showClearAllModal() {
            if (availableDates.length === 0) {
                showStatus('No dashboards to delete', 'warning');
                return;
            }
            pendingDeleteKey = null;
            pendingDeleteType = 'all';
            document.getElementById('deleteModalTitle').textContent = '‚ö†Ô∏è Clear ALL Dashboards';
            document.getElementById('deleteModalMessage').textContent = `This will permanently delete ALL ${availableDates.length} saved dashboards. This action cannot be undone!`;
            // Pre-fill email if user is logged in
            document.getElementById('deleteConfirmEmail').value = currentUser ? currentUser.email : '';
            document.getElementById('deleteConfirmPassword').value = '';
            document.getElementById('deleteModal').classList.remove('hidden');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            document.getElementById('deleteConfirmEmail').value = '';
            document.getElementById('deleteConfirmPassword').value = '';
            pendingDeleteKey = null;
            pendingDeleteType = 'single';
        }
        
        async function confirmDelete() {
            const email = document.getElementById('deleteConfirmEmail').value.trim();
            const password = document.getElementById('deleteConfirmPassword').value;
            
            if (!email || !password) {
                showStatus('Please enter both email and password.', 'error');
                return;
            }
            
            if (!firebaseInitialized || !auth) {
                showStatus('Firebase not initialized. Cannot verify credentials.', 'error');
                return;
            }
            
            try {
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(email, password);
                await currentUser.reauthenticateWithCredential(credential);
                
                // Authentication successful, proceed with deletion
                if (pendingDeleteType === 'all') {
                    deleteAllDashboards();
                } else if (pendingDeleteKey) {
                    deleteSingleDashboard(pendingDeleteKey);
                }
                
                closeDeleteModal();
                
            } catch (error) {
                console.error("Re-authentication error:", error);
                let errorMessage = 'Authentication failed. Deletion cancelled.';
                
                switch (error.code) {
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password. Deletion cancelled.';
                        break;
                    case 'auth/user-mismatch':
                        errorMessage = 'Email does not match logged in admin.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address.';
                        break;
                }
                
                showStatus(errorMessage, 'error');
                document.getElementById('deleteConfirmPassword').value = '';
            }
        }
        
        function deleteSingleDashboard(dateKey) {
            updateFirebaseStatus('syncing', 'üîÑ Deleting...');
            
            if (firebaseInitialized && database) {
                database.ref('dashboards/' + dateKey).remove()
                    .then(() => {
                        delete savedDashboards[dateKey];
                        availableDates = availableDates.filter(d => d !== dateKey);
                        renderSavedDatesList();
                        document.getElementById('savedDashboardsCount').textContent = availableDates.length;
                        
                        // If currently viewing deleted dashboard, clear it
                        if (reportResults.dateKey === dateKey) {
                            reportResults = {
                                aedc: { results: [], totals: {} },
                                bss: { results: [], totals: {} },
                                nysc: { results: [], totals: {} },
                                dateRange: '',
                                formattedDate: '',
                                dateKey: ''
                            };
                            updateDashboard();
                        }
                        
                        updateFirebaseStatus('connected', 'üü¢ Cloud Connected');
                        showStatus(`Dashboard for ${formatDateHeader(dateKey)} deleted successfully`, 'success');
                    })
                    .catch((error) => {
                        console.error("Delete error:", error);
                        updateFirebaseStatus('error', '‚ö†Ô∏è Delete Error');
                        showStatus('Failed to delete dashboard from cloud', 'error');
                    });
            } else {
                // Local storage delete
                delete savedDashboards[dateKey];
                availableDates = availableDates.filter(d => d !== dateKey);
                localStorage.setItem('savedDashboards', JSON.stringify(savedDashboards));
                renderSavedDatesList();
                document.getElementById('savedDashboardsCount').textContent = availableDates.length;
                
                if (reportResults.dateKey === dateKey) {
                    reportResults = {
                        aedc: { results: [], totals: {} },
                        bss: { results: [], totals: {} },
                        nysc: { results: [], totals: {} },
                        dateRange: '',
                        formattedDate: '',
                        dateKey: ''
                    };
                    updateDashboard();
                }
                
                showStatus(`Dashboard for ${formatDateHeader(dateKey)} deleted`, 'success');
            }
        }
        
        function deleteAllDashboards() {
            updateFirebaseStatus('syncing', 'üîÑ Clearing all...');
            
            if (firebaseInitialized && database) {
                database.ref('dashboards').remove()
                    .then(() => {
                        savedDashboards = {};
                        availableDates = [];
                        renderSavedDatesList();
                        document.getElementById('savedDashboardsCount').textContent = 0;
                        
                        reportResults = {
                            aedc: { results: [], totals: {} },
                            bss: { results: [], totals: {} },
                            nysc: { results: [], totals: {} },
                            dateRange: '',
                            formattedDate: '',
                            dateKey: ''
                        };
                        updateDashboard();
                        
                        updateFirebaseStatus('connected', 'üü¢ Cloud Connected');
                        showStatus('All dashboards deleted successfully', 'success');
                    })
                    .catch((error) => {
                        console.error("Delete all error:", error);
                        updateFirebaseStatus('error', '‚ö†Ô∏è Delete Error');
                        showStatus('Failed to delete dashboards from cloud', 'error');
                    });
            } else {
                // Local storage clear
                savedDashboards = {};
                availableDates = [];
                localStorage.setItem('savedDashboards', JSON.stringify(savedDashboards));
                renderSavedDatesList();
                document.getElementById('savedDashboardsCount').textContent = 0;
                
                reportResults = {
                    aedc: { results: [], totals: {} },
                    bss: { results: [], totals: {} },
                    nysc: { results: [], totals: {} },
                    dateRange: '',
                    formattedDate: '',
                    dateKey: ''
                };
                updateDashboard();
                
                showStatus('All dashboards deleted', 'success');
            }
        }
        
        function renderMappingRows(group) {
            const container = document.getElementById(`mappingContainer-${group}`);
            if (!container) return;
            container.innerHTML = '';
            
            usernameMappings[group].forEach((fullname, username) => {
                addMappingRow(group, username, fullname);
            });
            
            if (usernameMappings[group].size === 0) {
                addMappingRow(group);
                addMappingRow(group);
            }
        }

        // ============================================
        // ACCESS CONTROL
        // ============================================
        function enterPublicMode() {
            isAdminMode = false;
            document.body.classList.remove('admin-mode');
            document.getElementById('accessModal').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('accessBadge').textContent = 'üëÅÔ∏è Public View';
            document.getElementById('accessBadge').className = 'px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-700';
            
            document.querySelectorAll('.tab-content').forEach(el => {
                el.style.display = 'none';
            });
            
            switchTab('dashboard');
            loadSavedDates();
            // Re-render saved dates list without delete buttons
            setTimeout(() => renderSavedDatesList(), 500);
            showStatus('Welcome! You are viewing in Public Mode', 'info');
        }

        async function enterAdminMode() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const loginBtn = document.getElementById('adminLoginBtn');
            const errorDiv = document.getElementById('adminLoginError');
            
            if (!email || !password) {
                errorDiv.textContent = 'Please enter both email and password';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (!firebaseInitialized || !auth) {
                errorDiv.textContent = 'Firebase not initialized. Please refresh the page.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="animate-pulse">üîÑ Signing in...</span>';
            errorDiv.classList.add('hidden');
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                isAdminMode = true;
                document.body.classList.add('admin-mode');
                document.getElementById('accessModal').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('accessBadge').textContent = 'üîë Admin Mode';
                document.getElementById('accessBadge').className = 'px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-700';
                
                document.querySelectorAll('.tab-content').forEach(el => {
                    el.style.display = 'none';
                });
                
                switchTab('data');
                loadSavedDates();
                loadMappingsFromCloud();
                // Re-render saved dates list to show delete buttons
                setTimeout(() => renderSavedDatesList(), 500);
                showStatus(`Welcome Admin (${currentUser.email})! You have full access`, 'success');
                
            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = 'Login failed. Please try again.';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No admin account found with this email.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many failed attempts. Please try again later.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Please check your connection.';
                        break;
                }
                
                errorDiv.textContent = errorMessage;
                errorDiv.classList.remove('hidden');
                
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login as Admin';
            }
        }

        async function switchAccessMode() {
            // Sign out if currently signed in
            if (auth && currentUser) {
                try {
                    await auth.signOut();
                    currentUser = null;
                } catch (error) {
                    console.error("Sign out error:", error);
                }
            }
            
            isAdminMode = false;
            document.body.classList.remove('admin-mode');
            document.getElementById('accessModal').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('adminEmail').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminLoginError').classList.add('hidden');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            document.getElementById('dashStartDate').value = today;
            document.getElementById('dashEndDate').value = today;
            
            ['aedc', 'bss', 'nysc'].forEach(group => {
                addMappingRow(group);
                addMappingRow(group);
            });

            setupDragAndDrop();
            updateStats();
            initFirebase();
        });

        function switchTab(tabName) {
            if (!isAdminMode && tabName !== 'dashboard') {
                showStatus('Please login as Admin to access this section', 'warning');
                return;
            }
            
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('hidden');
                el.style.display = 'none';
            });
            
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.remove('tab-active'));
            
            const selectedContent = document.getElementById(`content-${tabName}`);
            selectedContent.classList.remove('hidden');
            selectedContent.style.display = 'block';
            
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');

            if (tabName === 'dashboard') {
                updateDashboard();
            }
        }

        function toggleDateMode() {
            const isRange = document.querySelector('input[name="dateMode"]:checked').value === 'range';
            document.getElementById('endDate').disabled = !isRange;
            if (!isRange) {
                document.getElementById('endDate').value = document.getElementById('startDate').value;
            }
        }

        function setupDragAndDrop() {
            const zones = document.querySelectorAll('.upload-zone');
            zones.forEach(zone => {
                zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
                zone.addEventListener('dragleave', () => { zone.classList.remove('dragover'); });
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('dragover');
                    const input = zone.querySelector('input[type="file"]');
                    const type = input.id.replace('file-', '');
                    if (e.dataTransfer.files.length) {
                        input.files = e.dataTransfer.files;
                        handleFileUpload(input, type);
                    }
                });
            });
        }

        function handleFileUpload(input, type) {
            const file = input.files[0];
            if (!file) return;

            const zone = document.getElementById(`zone-${type}`);
            const status = document.getElementById(`status-${type}`);
            status.textContent = 'Processing...';
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { raw: false, dateNF: 'yyyy-mm-dd' });
                    
                    uploadedData[type] = jsonData;
                    zone.classList.add('has-file');
                    status.innerHTML = `<span class="text-green-600">‚úì ${file.name}</span><br><span class="text-xs">${jsonData.length} rows</span>`;
                    updateStats();
                    showStatus(`Loaded ${jsonData.length} rows from ${file.name}`, 'success');
                } catch (error) {
                    status.textContent = 'Error loading file';
                    showStatus('Error loading file: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function updateStats() {
            const filesUploaded = Object.values(uploadedData).filter(d => d !== null).length;
            const totalRecords = Object.values(uploadedData).reduce((sum, d) => sum + (d ? d.length : 0), 0);
            const mappedCount = usernameMappings.aedc.size + usernameMappings.bss.size + usernameMappings.nysc.size;

            document.getElementById('filesCount').textContent = `${filesUploaded} / 5`;
            document.getElementById('totalRecords').textContent = totalRecords.toLocaleString();
            document.getElementById('mappedCount').textContent = mappedCount;
        }

        function addMappingRow(group, username = '', fullname = '') {
            const container = document.getElementById(`mappingContainer-${group}`);
            if (!container) return;
            
            const colors = { aedc: 'blue', bss: 'green', nysc: 'orange' };
            const color = colors[group];
            
            const row = document.createElement('div');
            row.className = 'flex gap-2 fade-in';
            row.innerHTML = `
                <input type="text" placeholder="Username" value="${username}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-${color}-500" onchange="updateMappings('${group}')">
                <input type="text" placeholder="Full Name" value="${fullname}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-${color}-500" onchange="updateMappings('${group}')">
                <button onclick="this.parentElement.remove(); updateMappings('${group}');" class="px-2 text-red-500 hover:text-red-700">‚úï</button>
            `;
            container.appendChild(row);
        }

        function updateMappings(group) {
            usernameMappings[group].clear();
            const rows = document.querySelectorAll(`#mappingContainer-${group} > div`);
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const username = inputs[0].value.trim().toLowerCase();
                const fullname = inputs[1].value.trim();
                if (username && fullname) {
                    usernameMappings[group].set(username, fullname);
                }
            });
            updateStats();
        }

        function importMappings(group) {
            const text = document.getElementById(`bulkMapping-${group}`).value;
            const lines = text.split('\n').filter(l => l.trim());
            
            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    addMappingRow(group, parts[0].trim(), parts.slice(1).join(',').trim());
                }
            });
            
            updateMappings(group);
            document.getElementById(`bulkMapping-${group}`).value = '';
            showStatus(`Imported ${lines.length} ${group.toUpperCase()} mappings`, 'success');
        }

        function parseDate(value) {
            if (!value) return null;
            if (value instanceof Date) return value;
            const parsed = new Date(value);
            if (!isNaN(parsed.getTime())) return parsed;
            if (typeof value === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                return new Date(excelEpoch.getTime() + value * 86400000);
            }
            return null;
        }

        function processDataSheet(data, startDate, endDate) {
            const counts = new Map();
            if (!data || !Array.isArray(data)) return counts;
            
            const sampleRow = data[0] || {};
            const columns = Object.keys(sampleRow);
            let timeCol = columns.find(c => c.toLowerCase().includes('time') || c.toLowerCase().includes('date'));
            let userCol = columns.find(c => c.toLowerCase().includes('username') || c.toLowerCase() === 'user');
            
            if (!timeCol || !userCol) return counts;
            
            data.forEach(row => {
                const timeValue = row[timeCol];
                const username = (row[userCol] || '').toString().trim().toLowerCase();
                if (!username) return;
                
                const rowDate = parseDate(timeValue);
                if (!rowDate) return;
                
                const rowDateOnly = new Date(rowDate.getFullYear(), rowDate.getMonth(), rowDate.getDate());
                const startOnly = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                const endOnly = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
                
                if (rowDateOnly >= startOnly && rowDateOnly <= endOnly) {
                    counts.set(username, (counts.get(username) || 0) + 1);
                }
            });
            return counts;
        }

        function formatDateHeader(dateStr) {
            const date = new Date(dateStr);
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            const dayName = days[date.getDay()];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            
            const suffix = (day === 1 || day === 21 || day === 31) ? 'st' : (day === 2 || day === 22) ? 'nd' : (day === 3 || day === 23) ? 'rd' : 'th';
            
            return `${dayName} ${day}${suffix} ${month} ${year}`;
        }

        function generateReport() {
            ['aedc', 'bss', 'nysc'].forEach(group => updateMappings(group));
            
            const startDateStr = document.getElementById('startDate').value;
            let endDateStr = document.getElementById('endDate').value;
            
            if (!startDateStr) {
                showStatus('Please select a start date', 'error');
                return;
            }
            
            const isRange = document.querySelector('input[name="dateMode"]:checked').value === 'range';
            if (!isRange) endDateStr = startDateStr;
            
            if (endDateStr < startDateStr) {
                showStatus('End date cannot be before start date', 'error');
                return;
            }
            
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            const hasData = Object.values(uploadedData).some(d => d !== null);
            if (!hasData) {
                showStatus('Please upload at least one data file', 'error');
                return;
            }
            
            const dssCounts = processDataSheet(uploadedData.dss, startDate, endDate);
            const htCounts = processDataSheet(uploadedData.ht, startDate, endDate);
            const ltCounts = processDataSheet(uploadedData.lt, startDate, endDate);
            const custCounts = processDataSheet(uploadedData.cust, startDate, endDate);
            const issueCounts = processDataSheet(uploadedData.issues, startDate, endDate);

            reportResults.dateRange = startDateStr === endDateStr ? `(${startDateStr})` : `(${startDateStr} to ${endDateStr})`;
            reportResults.formattedDate = isRange 
                ? `${formatDateHeader(startDateStr)} - ${formatDateHeader(endDateStr)}`
                : formatDateHeader(startDateStr);
            reportResults.dateKey = startDateStr === endDateStr ? startDateStr : `${startDateStr}_to_${endDateStr}`;

            ['aedc', 'bss', 'nysc'].forEach(group => {
                const groupResults = [];
                let groupTotals = { dss: 0, ht: 0, cust: 0, lt: 0, issues: 0, total: 0 };
                
                usernameMappings[group].forEach((fullname, username) => {
                    const dss = dssCounts.get(username) || 0;
                    const ht = htCounts.get(username) || 0;
                    const cust = custCounts.get(username) || 0;
                    const lt = ltCounts.get(username) || 0;
                    const issues = issueCounts.get(username) || 0;
                    const total = dss + ht + cust + lt + issues;
                    
                    groupResults.push({ 
                        username, fullname, dss, ht, cust, lt, issues, total,
                        status: total > 0 ? 'present' : 'present'
                    });
                    
                    groupTotals.dss += dss;
                    groupTotals.ht += ht;
                    groupTotals.cust += cust;
                    groupTotals.lt += lt;
                    groupTotals.issues += issues;
                    groupTotals.total += total;
                });
                
                groupResults.sort((a, b) => b.total - a.total);
                reportResults[group] = { results: groupResults, totals: groupTotals };
            });
            
            renderAllResults(startDateStr, endDateStr);
            updateDashboard();
            
            const totalEntries = reportResults.aedc.totals.total + reportResults.bss.totals.total + reportResults.nysc.totals.total;
            const totalUsers = reportResults.aedc.results.length + reportResults.bss.results.length + reportResults.nysc.results.length;
            
            showStatus(`Report generated: ${totalUsers} users, ${totalEntries} total entries`, 'success');
        }

        function updateStatus(group, index, status) {
            if (reportResults[group] && reportResults[group].results[index]) {
                reportResults[group].results[index].status = status;
                updateDashboard();
            }
        }

        function renderGroupTable(group, bgClass) {
            const { results, totals } = reportResults[group];
            const tbody = document.getElementById(`resultsBody${capitalize(group)}`);
            const tfoot = document.getElementById(`resultsTfoot${capitalize(group)}`);
            const dateDisplay = document.getElementById(`dateRange${capitalize(group)}`);
            
            if (!tbody || !tfoot) return;
            
            dateDisplay.textContent = reportResults.dateRange;
            
            tbody.innerHTML = results.map((r, i) => `
                <tr class="${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-${bgClass}-50 transition-colors">
                    <td class="border-b">${i + 1}</td>
                    <td class="border-b font-medium">${escapeHtml(r.fullname)}</td>
                    <td class="border-b text-center">${r.dss || '-'}</td>
                    <td class="border-b text-center">${r.ht || '-'}</td>
                    <td class="border-b text-center">${r.cust || '-'}</td>
                    <td class="border-b text-center">${r.lt || '-'}</td>
                    <td class="border-b text-center">${r.issues || '-'}</td>
                    <td class="border-b text-center">
                        <select onchange="updateStatus('${group}', ${i}, this.value)" class="status-select status-${r.status}">
                            <option value="present" ${r.status === 'present' ? 'selected' : ''}>${r.total} ‚úì</option>
                            <option value="absent" ${r.status === 'absent' ? 'selected' : ''}>Absent</option>
                            <option value="sick" ${r.status === 'sick' ? 'selected' : ''}>Sick</option>
                            <option value="excused" ${r.status === 'excused' ? 'selected' : ''}>Excused</option>
                        </select>
                    </td>
                </tr>
            `).join('');
            
            tfoot.innerHTML = `
                <tr>
                    <td colspan="2">TOTAL (${results.length} enumerators)</td>
                    <td class="text-center">${totals.dss}</td>
                    <td class="text-center">${totals.ht}</td>
                    <td class="text-center">${totals.cust}</td>
                    <td class="text-center">${totals.lt}</td>
                    <td class="text-center">${totals.issues}</td>
                    <td class="text-center font-bold">${totals.total}</td>
                </tr>
            `;
        }

        function renderAllResults(startDate, endDate) {
            renderGroupTable('aedc', 'blue');
            renderGroupTable('bss', 'green');
            renderGroupTable('nysc', 'orange');
            
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updateDashboard() {
            document.getElementById('dashboardDateHeader').textContent = reportResults.formattedDate 
                ? `üìä ${reportResults.formattedDate} Enumeration Dashboard`
                : 'üìä Enumeration Dashboard';
            document.getElementById('dashboardSubtitle').textContent = reportResults.dateRange || 'Select a date to view dashboard';

            let presentCount = 0, absentCount = 0, sickCount = 0, excusedCount = 0;
            const absentList = [], sickList = [], excusedList = [];

            ['aedc', 'bss', 'nysc'].forEach(group => {
                const groupLabel = group.toUpperCase();
                (reportResults[group].results || []).forEach(r => {
                    switch(r.status) {
                        case 'present': presentCount++; break;
                        case 'absent': absentCount++; absentList.push(`${r.fullname} (${groupLabel})`); break;
                        case 'sick': sickCount++; sickList.push(`${r.fullname} (${groupLabel})`); break;
                        case 'excused': excusedCount++; excusedList.push(`${r.fullname} (${groupLabel})`); break;
                    }
                });
            });

            document.getElementById('presentCount').textContent = presentCount;
            document.getElementById('absentCount').textContent = absentCount;
            document.getElementById('sickCount').textContent = sickCount;
            document.getElementById('excusedCount').textContent = excusedCount;

            document.getElementById('absentList').innerHTML = absentList.length 
                ? absentList.map(n => `<li style="padding: 8px; background-color: #fef2f2; border-radius: 6px; color: #b91c1c; font-size: 0.875rem;">${n}</li>`).join('')
                : '<li style="color: #6b7280; font-style: italic;">None</li>';
            document.getElementById('sickList').innerHTML = sickList.length 
                ? sickList.map(n => `<li style="padding: 8px; background-color: #fefce8; border-radius: 6px; color: #a16207; font-size: 0.875rem;">${n}</li>`).join('')
                : '<li style="color: #6b7280; font-style: italic;">None</li>';
            document.getElementById('excusedList').innerHTML = excusedList.length 
                ? excusedList.map(n => `<li style="padding: 8px; background-color: #eef2ff; border-radius: 6px; color: #4338ca; font-size: 0.875rem;">${n}</li>`).join('')
                : '<li style="color: #6b7280; font-style: italic;">None</li>';

            ['aedc', 'bss', 'nysc'].forEach(group => {
                const results = (reportResults[group].results || []).filter(r => r.status === 'present');
                const sorted = [...results].sort((a, b) => b.total - a.total);
                const top = sorted[0];
                const least = sorted[sorted.length - 1];
                
                document.getElementById(`${group}TopName`).textContent = top ? top.fullname : '-';
                document.getElementById(`${group}TopCount`).textContent = top ? `(${top.total})` : '(0)';
                document.getElementById(`${group}LeastName`).textContent = least ? least.fullname : '-';
                document.getElementById(`${group}LeastCount`).textContent = least ? `(${least.total})` : '(0)';
                document.getElementById(`${group}TotalDash`).textContent = (reportResults[group].totals || {}).total || 0;
            });

            updateGrandTotalTable();
            updateDashboardTables();
            updateCharts();
        }

        function updateDashboardTables() {
            renderDashboardGroupTable('aedc', 'blue');
            renderDashboardGroupTable('bss', 'green');
            renderDashboardGroupTable('nysc', 'orange');
        }

        function renderDashboardGroupTable(group, bgClass) {
            const { results, totals } = reportResults[group] || { results: [], totals: {} };
            const tbody = document.getElementById(`dashboardBody${capitalize(group)}`);
            const tfoot = document.getElementById(`dashboardTfoot${capitalize(group)}`);
            
            if (!tbody || !tfoot) return;
            
            const groupColors = {
                'aedc': { bg: '#eff6ff', altBg: '#dbeafe', border: '#bfdbfe' },
                'bss': { bg: '#f0fdf4', altBg: '#dcfce7', border: '#bbf7d0' },
                'nysc': { bg: '#fff7ed', altBg: '#ffedd5', border: '#fed7aa' }
            };
            const colors = groupColors[group] || groupColors['aedc'];
            
            const statusLabels = {
                'present': '<span style="padding: 1px 6px; background-color: #dcfce7; color: #166534; border-radius: 9999px; font-size: 9px; font-weight: 500;">Present</span>',
                'absent': '<span style="padding: 1px 6px; background-color: #fee2e2; color: #991b1b; border-radius: 9999px; font-size: 9px; font-weight: 500;">Absent</span>',
                'sick': '<span style="padding: 1px 6px; background-color: #fef3c7; color: #92400e; border-radius: 9999px; font-size: 9px; font-weight: 500;">Sick</span>',
                'excused': '<span style="padding: 1px 6px; background-color: #e0e7ff; color: #3730a3; border-radius: 9999px; font-size: 9px; font-weight: 500;">Excused</span>'
            };
            
            tbody.innerHTML = (results || []).map((r, i) => `
                <tr style="background-color: ${i % 2 === 0 ? colors.bg : colors.altBg};">
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; font-size: 10px;">${i + 1}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; font-weight: 500; font-size: 10px;">${escapeHtml(r.fullname)}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center; font-size: 10px;">${r.dss || '-'}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center; font-size: 10px;">${r.ht || '-'}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center; font-size: 10px;">${r.cust || '-'}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center; font-size: 10px;">${r.lt || '-'}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center; font-size: 10px;">${r.issues || '-'}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center; font-weight: bold; font-size: 10px;">${r.total}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center;">${statusLabels[r.status] || statusLabels['present']}</td>
                </tr>
            `).join('');
            
            tfoot.innerHTML = `
                <tr>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; font-size: 10px;" colspan="2">TOTAL (${(results || []).length})</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center; font-size: 10px;">${totals.dss || 0}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center; font-size: 10px;">${totals.ht || 0}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center; font-size: 10px;">${totals.cust || 0}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center; font-size: 10px;">${totals.lt || 0}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center; font-size: 10px;">${totals.issues || 0}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center; font-weight: bold; font-size: 10px;">${totals.total || 0}</td>
                    <td style="border: 1px solid ${colors.border}; padding: 2px 6px; text-align: center;"></td>
                </tr>
            `;
        }

        function updateGrandTotalTable() {
            const grandTotalBody = document.getElementById('bodyGrandTotal');
            const grandTotalFoot = document.getElementById('footGrandTotal');
            
            if (!grandTotalBody || !grandTotalFoot) return;
            
            const groups = [
                { name: 'AEDC Enumerators', data: reportResults.aedc.totals || {}, color: '#3b82f6', bg: '#eff6ff' },
                { name: 'BSS Enumerators', data: reportResults.bss.totals || {}, color: '#22c55e', bg: '#f0fdf4' },
                { name: 'NYSC Enumerators', data: reportResults.nysc.totals || {}, color: '#f97316', bg: '#fff7ed' }
            ];
            
            grandTotalBody.innerHTML = groups.map((g, i) => `
                <tr style="background-color: ${g.bg};">
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; font-weight: 500; font-size: 10px;">
                        <span style="display: inline-flex; align-items: center; gap: 6px;">
                            <span style="width: 10px; height: 10px; background-color: ${g.color}; border-radius: 50%;"></span>
                            ${g.name}
                        </span>
                    </td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; text-align: center; font-size: 10px;">${g.data.dss || 0}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; text-align: center; font-size: 10px;">${g.data.ht || 0}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; text-align: center; font-size: 10px;">${g.data.cust || 0}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; text-align: center; font-size: 10px;">${g.data.lt || 0}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; text-align: center; font-size: 10px;">${g.data.issues || 0}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; text-align: center; font-weight: bold; font-size: 10px;">${g.data.total || 0}</td>
                </tr>
            `).join('');
            
            const grandTotals = {
                dss: ((reportResults.aedc.totals || {}).dss || 0) + ((reportResults.bss.totals || {}).dss || 0) + ((reportResults.nysc.totals || {}).dss || 0),
                ht: ((reportResults.aedc.totals || {}).ht || 0) + ((reportResults.bss.totals || {}).ht || 0) + ((reportResults.nysc.totals || {}).ht || 0),
                cust: ((reportResults.aedc.totals || {}).cust || 0) + ((reportResults.bss.totals || {}).cust || 0) + ((reportResults.nysc.totals || {}).cust || 0),
                lt: ((reportResults.aedc.totals || {}).lt || 0) + ((reportResults.bss.totals || {}).lt || 0) + ((reportResults.nysc.totals || {}).lt || 0),
                issues: ((reportResults.aedc.totals || {}).issues || 0) + ((reportResults.bss.totals || {}).issues || 0) + ((reportResults.nysc.totals || {}).issues || 0),
                total: ((reportResults.aedc.totals || {}).total || 0) + ((reportResults.bss.totals || {}).total || 0) + ((reportResults.nysc.totals || {}).total || 0)
            };
            
            grandTotalFoot.innerHTML = `
                <tr>
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; font-size: 10px;">GRAND TOTAL</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; text-align: center; font-size: 10px;">${grandTotals.dss}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; text-align: center; font-size: 10px;">${grandTotals.ht}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; text-align: center; font-size: 10px;">${grandTotals.cust}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; text-align: center; font-size: 10px;">${grandTotals.lt}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; text-align: center; font-size: 10px;">${grandTotals.issues}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 6px; text-align: center; font-size: 10px;">${grandTotals.total}</td>
                </tr>
            `;
        }

        function updateCharts() {
            if (pieChart) pieChart.destroy();
            if (barChart) barChart.destroy();

            const aedcTotal = (reportResults.aedc.totals || {}).total || 0;
            const bssTotal = (reportResults.bss.totals || {}).total || 0;
            const nyscTotal = (reportResults.nysc.totals || {}).total || 0;

            const pieCtx = document.getElementById('pieChart');
            if (pieCtx) {
                pieChart = new Chart(pieCtx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: [`AEDC (${aedcTotal})`, `BSS (${bssTotal})`, `NYSC (${nyscTotal})`],
                        datasets: [{
                            data: [aedcTotal, bssTotal, nyscTotal],
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(249, 115, 22, 0.8)'
                            ],
                            borderColor: [
                                'rgba(59, 130, 246, 1)',
                                'rgba(34, 197, 94, 1)',
                                'rgba(249, 115, 22, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { 
                                    padding: 15, 
                                    font: { size: 12, weight: 'bold' },
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : 0;
                                        return `${context.raw} entries (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            const grandTotals = {
                dss: ((reportResults.aedc.totals || {}).dss || 0) + ((reportResults.bss.totals || {}).dss || 0) + ((reportResults.nysc.totals || {}).dss || 0),
                ht: ((reportResults.aedc.totals || {}).ht || 0) + ((reportResults.bss.totals || {}).ht || 0) + ((reportResults.nysc.totals || {}).ht || 0),
                cust: ((reportResults.aedc.totals || {}).cust || 0) + ((reportResults.bss.totals || {}).cust || 0) + ((reportResults.nysc.totals || {}).cust || 0),
                lt: ((reportResults.aedc.totals || {}).lt || 0) + ((reportResults.bss.totals || {}).lt || 0) + ((reportResults.nysc.totals || {}).lt || 0),
                issues: ((reportResults.aedc.totals || {}).issues || 0) + ((reportResults.bss.totals || {}).issues || 0) + ((reportResults.nysc.totals || {}).issues || 0)
            };

            const barCtx = document.getElementById('barChart');
            if (barCtx) {
                barChart = new Chart(barCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['DT/DSS', 'HT Pole', 'Customer', 'LT Pole', 'Issues'],
                        datasets: [{
                            label: 'Total Count',
                            data: [grandTotals.dss, grandTotals.ht, grandTotals.cust, grandTotals.lt, grandTotals.issues],
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(249, 115, 22, 0.8)',
                                'rgba(234, 179, 8, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(239, 68, 68, 0.8)'
                            ],
                            borderColor: [
                                'rgba(59, 130, 246, 1)',
                                'rgba(249, 115, 22, 1)',
                                'rgba(234, 179, 8, 1)',
                                'rgba(34, 197, 94, 1)',
                                'rgba(239, 68, 68, 1)'
                            ],
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0,0,0,0.05)' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function exportToExcel() {
            const hasData = (reportResults.aedc.results || []).length || (reportResults.bss.results || []).length || (reportResults.nysc.results || []).length;
            if (!hasData) {
                showStatus('No data to export. Generate a report first.', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            ['aedc', 'bss', 'nysc'].forEach(group => {
                const { results, totals } = reportResults[group];
                if ((results || []).length > 0) {
                    const sheetData = [
                        ['S/N', 'Full Name', 'DT/DSS', 'HT Pole', 'Customer', 'LT Pole', 'Issues', 'Total', 'Status'],
                        ...results.map((r, i) => [i + 1, r.fullname, r.dss, r.ht, r.cust, r.lt, r.issues, r.total, r.status]),
                        ['', 'TOTAL', totals.dss, totals.ht, totals.cust, totals.lt, totals.issues, totals.total, '']
                    ];
                    const ws = XLSX.utils.aoa_to_sheet(sheetData);
                    ws['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }];
                    XLSX.utils.book_append_sheet(wb, ws, `${group.toUpperCase()} Enumerators`);
                }
            });
            
            const filename = `Report_Summary_${reportResults.dateKey || 'report'}.xlsx`;
            XLSX.writeFile(wb, filename);
            showStatus('Report exported successfully', 'success');
        }

        function exportDashboard() {
            const hasData = (reportResults.aedc.results || []).length || (reportResults.bss.results || []).length || (reportResults.nysc.results || []).length;
            if (!hasData) {
                showStatus('No data to export. Load a dashboard first.', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            const summaryData = [
                ['ENUMERATION DASHBOARD SUMMARY'],
                [reportResults.formattedDate],
                [''],
                ['ATTENDANCE SUMMARY'],
                ['Present', document.getElementById('presentCount').textContent],
                ['Absent', document.getElementById('absentCount').textContent],
                ['Sick', document.getElementById('sickCount').textContent],
                ['Excused', document.getElementById('excusedCount').textContent],
                [''],
                ['GROUP TOTALS'],
                ['Group', 'DT/DSS', 'HT Pole', 'Customer', 'LT Pole', 'Issues', 'Total'],
                ['AEDC', (reportResults.aedc.totals || {}).dss || 0, (reportResults.aedc.totals || {}).ht || 0, (reportResults.aedc.totals || {}).cust || 0, (reportResults.aedc.totals || {}).lt || 0, (reportResults.aedc.totals || {}).issues || 0, (reportResults.aedc.totals || {}).total || 0],
                ['BSS', (reportResults.bss.totals || {}).dss || 0, (reportResults.bss.totals || {}).ht || 0, (reportResults.bss.totals || {}).cust || 0, (reportResults.bss.totals || {}).lt || 0, (reportResults.bss.totals || {}).issues || 0, (reportResults.bss.totals || {}).total || 0],
                ['NYSC', (reportResults.nysc.totals || {}).dss || 0, (reportResults.nysc.totals || {}).ht || 0, (reportResults.nysc.totals || {}).cust || 0, (reportResults.nysc.totals || {}).lt || 0, (reportResults.nysc.totals || {}).issues || 0, (reportResults.nysc.totals || {}).total || 0]
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), 'Summary');
            
            ['aedc', 'bss', 'nysc'].forEach(group => {
                const { results, totals } = reportResults[group] || { results: [], totals: {} };
                const sheetData = [
                    [`${group.toUpperCase()} ENUMERATORS ${reportResults.dateRange}`],
                    [''],
                    ['S/N', 'Full Name', 'DT/DSS', 'HT Pole', 'Customer', 'LT Pole', 'Issues', 'Total', 'Status'],
                    ...(results || []).map((r, i) => [i + 1, r.fullname, r.dss, r.ht, r.cust, r.lt, r.issues, r.total, r.status]),
                    ['', 'TOTAL', totals.dss || 0, totals.ht || 0, totals.cust || 0, totals.lt || 0, totals.issues || 0, totals.total || 0, '']
                ];
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheetData), group.toUpperCase());
            });
            
            XLSX.writeFile(wb, `Dashboard_${reportResults.dateKey || 'report'}.xlsx`);
            showStatus('Dashboard exported successfully', 'success');
        }

        function printDashboard() {
            window.print();
        }

        function exportToPNG(groupType = 'full') {
            const hasData = (reportResults.aedc.results || []).length || (reportResults.bss.results || []).length || (reportResults.nysc.results || []).length;
            if (!hasData) {
                showStatus('No data to export. Load a dashboard first.', 'error');
                return;
            }

            showStatus('Generating PNG... Please wait', 'info');

            // Get chart images before creating export element
            let pieChartDataUrl = null;
            let barChartDataUrl = null;
            
            try {
                const pieCanvas = document.getElementById('pieChart');
                const barCanvas = document.getElementById('barChart');
                
                if (pieCanvas && pieChart) {
                    pieChartDataUrl = pieCanvas.toDataURL('image/png', 1.0);
                }
                if (barCanvas && barChart) {
                    barChartDataUrl = barCanvas.toDataURL('image/png', 1.0);
                }
            } catch (e) {
                console.warn('Could not capture charts:', e);
            }

            // Check which sections are visible
            const showAedc = document.getElementById('showAedc').checked;
            const showBss = document.getElementById('showBss').checked;
            const showNysc = document.getElementById('showNysc').checked;
            const showGrandTotal = document.getElementById('showGrandTotal').checked;
            const showAbsentSick = document.getElementById('showAbsentSick').checked;
            const showCharts = document.getElementById('showCharts').checked;

            // Create a custom export element
            const exportDiv = document.createElement('div');
            exportDiv.style.cssText = 'position: absolute; left: -9999px; background: #f3f4f6; padding: 16px; width: 800px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;';
            
            // Build visible tables
            let tableHTML = '';
            const groupColors = {
                'aedc': { bg: '#eff6ff', header: '#3b82f6', name: 'AEDC' },
                'bss': { bg: '#f0fdf4', header: '#22c55e', name: 'BSS' },
                'nysc': { bg: '#fff7ed', header: '#f97316', name: 'NYSC' }
            };
            
            if (showAedc) tableHTML += buildGroupTableHTML('aedc', groupColors['aedc']);
            if (showBss) tableHTML += buildGroupTableHTML('bss', groupColors['bss']);
            if (showNysc) tableHTML += buildGroupTableHTML('nysc', groupColors['nysc']);
            if (showGrandTotal) tableHTML += buildGrandTotalHTML();
            if (showAbsentSick) tableHTML += buildAbsentSickExcusedHTML();
            
            // Build charts HTML only if visible
            let chartsHTML = '';
            if (showCharts) {
                chartsHTML = `
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <div style="flex: 1; background: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <h3 style="font-size: 0.8rem; font-weight: 600; text-align: center; margin: 0 0 8px 0;">üìä Group Comparison</h3>
                            ${pieChartDataUrl ? `<img src="${pieChartDataUrl}" style="width: 100%; height: 180px; object-fit: contain;">` : '<div style="height: 180px; display: flex; align-items: center; justify-content: center; color: #9ca3af;">[Pie Chart]</div>'}
                        </div>
                        <div style="flex: 1; background: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <h3 style="font-size: 0.8rem; font-weight: 600; text-align: center; margin: 0 0 8px 0;">üìà Asset Distribution</h3>
                            ${barChartDataUrl ? `<img src="${barChartDataUrl}" style="width: 100%; height: 180px; object-fit: contain;">` : '<div style="height: 180px; display: flex; align-items: center; justify-content: center; color: #9ca3af;">[Bar Chart]</div>'}
                        </div>
                    </div>
                `;
            }
            
            exportDiv.innerHTML = `
                <!-- Header -->
                <div style="background: linear-gradient(to right, #9333ea, #2563eb); border-radius: 8px; padding: 16px; margin-bottom: 12px; color: white; text-align: center;">
                    <h2 style="font-size: 1.1rem; font-weight: bold; margin: 0 0 4px 0;">üìä ${reportResults.formattedDate || 'Enumeration Dashboard'}</h2>
                    <p style="font-size: 0.8rem; opacity: 0.9; margin: 0;">${reportResults.dateRange || ''}</p>
                </div>
                
                <!-- Top/Least Performers -->
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    ${buildPerformerCardHTML('aedc', '#3b82f6', 'AEDC')}
                    ${buildPerformerCardHTML('bss', '#22c55e', 'BSS')}
                    ${buildPerformerCardHTML('nysc', '#f97316', 'NYSC')}
                </div>
                
                <!-- Attendance Summary -->
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <div style="flex: 1; background: linear-gradient(to bottom right, #4ade80, #16a34a); border-radius: 6px; padding: 4px 8px; color: white; text-align: center;">
                        <div style="font-size: 1rem; line-height: 1;">üë•</div>
                        <div style="font-size: 0.55rem; opacity: 0.9;">Present</div>
                        <div style="font-size: 1rem; font-weight: bold;">${document.getElementById('presentCount').textContent}</div>
                    </div>
                    <div style="flex: 1; background: linear-gradient(to bottom right, #f87171, #dc2626); border-radius: 6px; padding: 4px 8px; color: white; text-align: center;">
                        <div style="font-size: 1rem; line-height: 1;">üö´</div>
                        <div style="font-size: 0.55rem; opacity: 0.9;">Absent</div>
                        <div style="font-size: 1rem; font-weight: bold;">${document.getElementById('absentCount').textContent}</div>
                    </div>
                    <div style="flex: 1; background: linear-gradient(to bottom right, #818cf8, #4f46e5); border-radius: 6px; padding: 4px 8px; color: white; text-align: center;">
                        <div style="font-size: 1rem; line-height: 1;">üìù</div>
                        <div style="font-size: 0.55rem; opacity: 0.9;">Excused</div>
                        <div style="font-size: 1rem; font-weight: bold;">${document.getElementById('excusedCount').textContent}</div>
                    </div>
                    <div style="flex: 1; background: linear-gradient(to bottom right, #facc15, #ca8a04); border-radius: 6px; padding: 4px 8px; color: white; text-align: center;">
                        <div style="font-size: 1rem; line-height: 1;">ü§í</div>
                        <div style="font-size: 0.55rem; opacity: 0.9;">Sick</div>
                        <div style="font-size: 1rem; font-weight: bold;">${document.getElementById('sickCount').textContent}</div>
                    </div>
                </div>
                
                <!-- Charts -->
                ${chartsHTML}
                
                <!-- Tables -->
                ${tableHTML}
            `;
            
            document.body.appendChild(exportDiv);
            
            // Use setTimeout to allow the DOM to render before capturing
            setTimeout(() => {
                html2canvas(exportDiv, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#f3f4f6',
                    logging: false
                }).then(canvas => {
                    document.body.removeChild(exportDiv);
                    const link = document.createElement('a');
                    const filename = `Dashboard_${reportResults.dateKey || 'report'}.png`;
                    link.download = filename;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    showStatus('PNG exported successfully!', 'success');
                }).catch(err => {
                    document.body.removeChild(exportDiv);
                    console.error('PNG Export Error:', err);
                    showStatus('PNG export failed. Try using Print instead.', 'error');
                });
            }, 200);
        }
        
        function buildPerformerCardHTML(group, color, name) {
            const results = (reportResults[group].results || []).filter(r => r.status === 'present');
            const sorted = [...results].sort((a, b) => b.total - a.total);
            const top = sorted[0];
            const least = sorted[sorted.length - 1];
            const total = (reportResults[group].totals || {}).total || 0;
            
            return `
                <div style="flex: 1; background: white; border-radius: 6px; padding: 8px; border-left: 3px solid ${color}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="text-align: center; margin-bottom: 6px;">
                        <span style="font-size: 1rem;">üèÜ</span>
                        <div style="font-size: 0.75rem; font-weight: bold; color: ${color};">${name}</div>
                    </div>
                    <div style="background: #f0fdf4; padding: 4px 6px; border-radius: 4px; margin-bottom: 4px;">
                        <div style="font-size: 0.55rem; color: #16a34a; font-weight: 600;">üèÖ Top</div>
                        <div style="font-size: 0.7rem; font-weight: bold; color: #166534;">${top ? top.fullname : '-'}</div>
                        <div style="font-size: 0.65rem; color: #16a34a;">(${top ? top.total : 0})</div>
                    </div>
                    <div style="background: #fef2f2; padding: 4px 6px; border-radius: 4px; margin-bottom: 4px;">
                        <div style="font-size: 0.55rem; color: #dc2626; font-weight: 600;">üìâ Least</div>
                        <div style="font-size: 0.7rem; font-weight: bold; color: #991b1b;">${least ? least.fullname : '-'}</div>
                        <div style="font-size: 0.65rem; color: #dc2626;">(${least ? least.total : 0})</div>
                    </div>
                    <div style="background: #f3f4f6; padding: 4px 6px; border-radius: 4px; text-align: center;">
                        <div style="font-size: 0.9rem; font-weight: bold; color: #1f2937;">${total}</div>
                        <div style="font-size: 0.5rem; color: #6b7280;">Total</div>
                    </div>
                </div>
            `;
        }
        
        function buildGroupTableHTML(group, colors) {
            const { results, totals } = reportResults[group] || { results: [], totals: {} };
            const statusLabels = {
                'present': '<span style="padding: 1px 4px; background: #dcfce7; color: #166534; border-radius: 4px; font-size: 8px;">Present</span>',
                'absent': '<span style="padding: 1px 4px; background: #fee2e2; color: #991b1b; border-radius: 4px; font-size: 8px;">Absent</span>',
                'sick': '<span style="padding: 1px 4px; background: #fef3c7; color: #92400e; border-radius: 4px; font-size: 8px;">Sick</span>',
                'excused': '<span style="padding: 1px 4px; background: #e0e7ff; color: #3730a3; border-radius: 4px; font-size: 8px;">Excused</span>'
            };
            
            let rows = results.map((r, i) => `
                <tr style="background: ${i % 2 === 0 ? colors.bg : '#ffffff'};">
                    <td style="border: 1px solid #d1d5db; padding: 2px 4px; font-size: 9px;">${i + 1}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 4px; font-size: 9px; font-weight: 500;">${escapeHtml(r.fullname)}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 4px; font-size: 9px; text-align: center;">${r.dss || '-'}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 4px; font-size: 9px; text-align: center;">${r.ht || '-'}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 4px; font-size: 9px; text-align: center;">${r.cust || '-'}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 4px; font-size: 9px; text-align: center;">${r.lt || '-'}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 4px; font-size: 9px; text-align: center;">${r.issues || '-'}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 4px; font-size: 9px; text-align: center; font-weight: bold;">${r.total}</td>
                    <td style="border: 1px solid #d1d5db; padding: 2px 4px; text-align: center;">${statusLabels[r.status] || statusLabels['present']}</td>
                </tr>
            `).join('');
            
            return `
                <div style="background: white; border-radius: 8px; padding: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="font-size: 0.85rem; font-weight: 600; margin: 0 0 8px 0; display: flex; align-items: center; gap: 6px;">
                        <span style="width: 18px; height: 18px; background: ${colors.header}; color: white; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.6rem;">${colors.name.charAt(0)}</span>
                        ${colors.name} Enumerators
                    </h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
                        <thead>
                            <tr style="background: ${colors.bg};">
                                <th style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 8px;">S/N</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 8px; text-align: left;">Full Name</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 8px;">DT/DSS</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 8px;">HT</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 8px;">Cust</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 8px;">LT</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 8px;">Issues</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 8px;">Total</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 8px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                        <tfoot>
                            <tr style="background: ${colors.bg}; font-weight: bold;">
                                <td style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 9px;" colspan="2">TOTAL (${results.length})</td>
                                <td style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 9px; text-align: center;">${totals.dss || 0}</td>
                                <td style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 9px; text-align: center;">${totals.ht || 0}</td>
                                <td style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 9px; text-align: center;">${totals.cust || 0}</td>
                                <td style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 9px; text-align: center;">${totals.lt || 0}</td>
                                <td style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 9px; text-align: center;">${totals.issues || 0}</td>
                                <td style="border: 1px solid #d1d5db; padding: 3px 4px; font-size: 9px; text-align: center;">${totals.total || 0}</td>
                                <td style="border: 1px solid #d1d5db; padding: 3px 4px;"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }
        
        function buildGrandTotalHTML() {
            const groups = [
                { name: 'AEDC', data: reportResults.aedc.totals || {}, color: '#3b82f6' },
                { name: 'BSS', data: reportResults.bss.totals || {}, color: '#22c55e' },
                { name: 'NYSC', data: reportResults.nysc.totals || {}, color: '#f97316' }
            ];
            
            const grandTotals = {
                dss: groups.reduce((sum, g) => sum + (g.data.dss || 0), 0),
                ht: groups.reduce((sum, g) => sum + (g.data.ht || 0), 0),
                cust: groups.reduce((sum, g) => sum + (g.data.cust || 0), 0),
                lt: groups.reduce((sum, g) => sum + (g.data.lt || 0), 0),
                issues: groups.reduce((sum, g) => sum + (g.data.issues || 0), 0),
                total: groups.reduce((sum, g) => sum + (g.data.total || 0), 0)
            };
            
            let rows = groups.map((g, i) => `
                <tr style="background: ${i % 2 === 0 ? '#faf5ff' : '#ffffff'};">
                    <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px; font-weight: 500;">
                        <span style="display: inline-flex; align-items: center; gap: 4px;">
                            <span style="width: 8px; height: 8px; background: ${g.color}; border-radius: 50%;"></span>
                            ${g.name}
                        </span>
                    </td>
                    <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px; text-align: center;">${g.data.dss || 0}</td>
                    <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px; text-align: center;">${g.data.ht || 0}</td>
                    <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px; text-align: center;">${g.data.cust || 0}</td>
                    <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px; text-align: center;">${g.data.lt || 0}</td>
                    <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px; text-align: center;">${g.data.issues || 0}</td>
                    <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px; text-align: center; font-weight: bold;">${g.data.total || 0}</td>
                </tr>
            `).join('');
            
            return `
                <div style="background: white; border-radius: 8px; padding: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="font-size: 0.85rem; font-weight: 600; margin: 0 0 8px 0; display: flex; align-items: center; gap: 6px;">
                        <span style="width: 18px; height: 18px; background: #a855f7; color: white; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.6rem;">Œ£</span>
                        Grand Total Summary
                    </h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #faf5ff;">
                                <th style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 8px; text-align: left;">Group</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 8px;">DT/DSS</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 8px;">HT</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 8px;">Cust</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 8px;">LT</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 8px;">Issues</th>
                                <th style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 8px;">Total</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                        <tfoot>
                            <tr style="background: #e9d5ff; font-weight: bold;">
                                <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px;">GRAND TOTAL</td>
                                <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px; text-align: center;">${grandTotals.dss}</td>
                                <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px; text-align: center;">${grandTotals.ht}</td>
                                <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px; text-align: center;">${grandTotals.cust}</td>
                                <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px; text-align: center;">${grandTotals.lt}</td>
                                <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px; text-align: center;">${grandTotals.issues}</td>
                                <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 9px; text-align: center;">${grandTotals.total}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }
        
        function buildAbsentSickExcusedHTML() {
            const absentList = [], sickList = [], excusedList = [];
            
            ['aedc', 'bss', 'nysc'].forEach(group => {
                const groupLabel = group.toUpperCase();
                (reportResults[group].results || []).forEach(r => {
                    if (r.status === 'absent') absentList.push(`${r.fullname} (${groupLabel})`);
                    if (r.status === 'sick') sickList.push(`${r.fullname} (${groupLabel})`);
                    if (r.status === 'excused') excusedList.push(`${r.fullname} (${groupLabel})`);
                });
            });
            
            return `
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1; background: white; border-radius: 8px; padding: 10px; border-top: 3px solid #ef4444; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h4 style="font-size: 0.75rem; font-weight: 600; color: #dc2626; margin: 0 0 6px 0;">üö´ Absent</h4>
                        ${absentList.length ? absentList.map(n => `<div style="font-size: 0.65rem; padding: 2px 4px; background: #fef2f2; border-radius: 4px; margin-bottom: 2px; color: #991b1b;">${n}</div>`).join('') : '<div style="font-size: 0.65rem; color: #9ca3af; font-style: italic;">None</div>'}
                    </div>
                    <div style="flex: 1; background: white; border-radius: 8px; padding: 10px; border-top: 3px solid #eab308; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h4 style="font-size: 0.75rem; font-weight: 600; color: #ca8a04; margin: 0 0 6px 0;">ü§í Sick</h4>
                        ${sickList.length ? sickList.map(n => `<div style="font-size: 0.65rem; padding: 2px 4px; background: #fefce8; border-radius: 4px; margin-bottom: 2px; color: #a16207;">${n}</div>`).join('') : '<div style="font-size: 0.65rem; color: #9ca3af; font-style: italic;">None</div>'}
                    </div>
                    <div style="flex: 1; background: white; border-radius: 8px; padding: 10px; border-top: 3px solid #6366f1; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h4 style="font-size: 0.75rem; font-weight: 600; color: #4f46e5; margin: 0 0 6px 0;">üìù Excused</h4>
                        ${excusedList.length ? excusedList.map(n => `<div style="font-size: 0.65rem; padding: 2px 4px; background: #eef2ff; border-radius: 4px; margin-bottom: 2px; color: #4338ca;">${n}</div>`).join('') : '<div style="font-size: 0.65rem; color: #9ca3af; font-style: italic;">None</div>'}
                    </div>
                </div>
            `;
        }
        
        function exportToPNGFallback() {
            showStatus('Trying alternative export method...', 'info');
            
            const captureElement = document.getElementById('dashboardCapture');
            
            // Create a completely new element without any Tailwind classes
            const exportDiv = document.createElement('div');
            exportDiv.style.cssText = 'position: absolute; left: -9999px; background: #f3f4f6; padding: 20px; width: 1200px;';
            exportDiv.innerHTML = captureElement.innerHTML;
            document.body.appendChild(exportDiv);
            
            // Replace any remaining canvas elements with placeholders
            exportDiv.querySelectorAll('canvas').forEach(canvas => {
                const placeholder = document.createElement('div');
                placeholder.style.cssText = 'width: 100%; height: 300px; background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 14px;';
                placeholder.textContent = '[Chart - See Dashboard]';
                canvas.parentElement.replaceChild(placeholder, canvas);
            });
            
            html2canvas(exportDiv, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#f3f4f6',
                logging: false
            }).then(canvas => {
                document.body.removeChild(exportDiv);
                const link = document.createElement('a');
                link.download = `Dashboard_${reportResults.dateKey || 'report'}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showStatus('Dashboard exported (charts may be missing)', 'success');
            }).catch(err => {
                document.body.removeChild(exportDiv);
                console.error('Fallback PNG Export Error:', err);
                showStatus('PNG export failed. Please use Print (Ctrl+P) and save as PDF/Image.', 'error');
            });
        }

        function clearAll() {
            Object.keys(uploadedData).forEach(key => {
                uploadedData[key] = null;
                const zone = document.getElementById(`zone-${key}`);
                const status = document.getElementById(`status-${key}`);
                const file = document.getElementById(`file-${key}`);
                if (zone) zone.classList.remove('has-file');
                if (status) status.textContent = 'Click or drag to upload';
                if (file) file.value = '';
            });
            
            reportResults = {
                aedc: { results: [], totals: {} },
                bss: { results: [], totals: {} },
                nysc: { results: [], totals: {} },
                dateRange: '',
                formattedDate: '',
                dateKey: ''
            };
            
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) resultsSection.style.display = 'none';
            updateStats();
            updateDashboard();
            
            showStatus('All data cleared', 'info');
        }

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                info: 'bg-blue-500 text-white',
                warning: 'bg-yellow-500 text-black'
            };
            
            statusEl.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg transition-all transform ${colors[type]} no-print`;
            statusEl.textContent = message;
            statusEl.style.transform = 'translateY(0)';
            statusEl.style.opacity = '1';
            
            setTimeout(() => {
                statusEl.style.transform = 'translateY(20px)';
                statusEl.style.opacity = '0';
            }, 3000);
        }
        
        // ============================================
        // VISIBILITY TOGGLE FUNCTIONS
        // ============================================
        function toggleSection(section) {
            const sectionMap = {
                'aedc': 'sectionAedc',
                'bss': 'sectionBss',
                'nysc': 'sectionNysc',
                'grandTotal': 'sectionGrandTotal',
                'absentSick': 'sectionAbsentSick',
                'charts': 'sectionCharts'
            };
            
            const checkboxMap = {
                'aedc': 'showAedc',
                'bss': 'showBss',
                'nysc': 'showNysc',
                'grandTotal': 'showGrandTotal',
                'absentSick': 'showAbsentSick',
                'charts': 'showCharts'
            };
            
            const sectionEl = document.getElementById(sectionMap[section]);
            const checkbox = document.getElementById(checkboxMap[section]);
            
            if (sectionEl && checkbox) {
                if (checkbox.checked) {
                    sectionEl.style.display = section === 'charts' || section === 'absentSick' ? 'grid' : 'block';
                } else {
                    sectionEl.style.display = 'none';
                }
            }
        }
        
        function showAllSections() {
            ['aedc', 'bss', 'nysc', 'grandTotal', 'absentSick', 'charts'].forEach(section => {
                const checkboxMap = {
                    'aedc': 'showAedc',
                    'bss': 'showBss',
                    'nysc': 'showNysc',
                    'grandTotal': 'showGrandTotal',
                    'absentSick': 'showAbsentSick',
                    'charts': 'showCharts'
                };
                const checkbox = document.getElementById(checkboxMap[section]);
                if (checkbox) {
                    checkbox.checked = true;
                    toggleSection(section);
                }
            });
            showStatus('All sections visible', 'info');
        }
        
        function showOnlyAedc() {
            setVisibility({ aedc: true, bss: false, nysc: false, grandTotal: true, absentSick: true, charts: true });
            showStatus('Showing AEDC table only', 'info');
        }
        
        function showOnlyBss() {
            setVisibility({ aedc: false, bss: true, nysc: false, grandTotal: true, absentSick: true, charts: true });
            showStatus('Showing BSS table only', 'info');
        }
        
        function showOnlyNysc() {
            setVisibility({ aedc: false, bss: false, nysc: true, grandTotal: true, absentSick: true, charts: true });
            showStatus('Showing NYSC table only', 'info');
        }
        
        function setVisibility(visibility) {
            const checkboxMap = {
                'aedc': 'showAedc',
                'bss': 'showBss',
                'nysc': 'showNysc',
                'grandTotal': 'showGrandTotal',
                'absentSick': 'showAbsentSick',
                'charts': 'showCharts'
            };
            
            Object.keys(visibility).forEach(section => {
                const checkbox = document.getElementById(checkboxMap[section]);
                if (checkbox) {
                    checkbox.checked = visibility[section];
                    toggleSection(section);
                }
            });
        }
    </script>
</body>
</html>
